/* Source version: 1.1.7 */
(function(b){var l=(typeof b.define=="function"&&b.define.amd);var u="object",d="function",A="undefined";var a=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var q=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"];var m=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"];var F=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"];function C(N,M){var L=typeof N[M];return L==d||(!!(L==u&&N[M]))||L=="unknown"}function y(M,L){return !!(typeof M[L]==u&&M[L])}function e(M,L){return typeof M[L]!=A}function w(L){return function(O,N){var M=N.length;while(M--){if(!L(O,N[M])){return false}}return true}}var k=w(C);var t=w(y);var g=w(e);function z(L){return L&&k(L,F)&&g(L,m)}function I(L){return y(L,"body")?L.body:L.getElementsByTagName("body")[0]}var v={};var h={version:"1.3alpha.804",initialized:false,supported:true,util:{isHostMethod:C,isHostObject:y,isHostProperty:e,areHostMethods:k,areHostObjects:t,areHostProperties:g,isTextRange:z,getBody:I},features:{},modules:v,config:{alertOnFail:true,alertOnWarn:false,preferTextRange:false}};function E(L){if(y(window,"console")&&C(window.console,"log")){window.console.log(L)}}function p(M,L){if(L){window.alert(M)}else{E(M)}}function n(L){h.initialized=true;h.supported=false;p("Rangy is not supported on this page in your browser. Reason: "+L,h.config.alertOnFail)}h.fail=n;function o(L){p("Rangy warning: "+L,h.config.alertOnWarn)}h.warn=o;if({}.hasOwnProperty){h.util.extend=function(P,N,L){var Q,O;for(var M in N){if(N.hasOwnProperty(M)){Q=P[M];O=N[M];if(L&&Q!==null&&typeof Q=="object"&&O!==null&&typeof O=="object"){h.util.extend(Q,O,true)}P[M]=O}}return P}}else{n("hasOwnProperty not supported")}(function(){var M=document.createElement("div");M.appendChild(document.createElement("span"));var O=[].slice;var L;try{if(O.call(M.childNodes,0)[0].nodeType==1){L=function(P){return O.call(P,0)}}}catch(N){}if(!L){L=function(R){var Q=[];for(var S=0,P=R.length;S<P;++S){Q[S]=R[S]}return Q}}h.util.toArray=L})();var i;if(C(document,"addEventListener")){i=function(N,L,M){N.addEventListener(L,M,false)}}else{if(C(document,"attachEvent")){i=function(N,L,M){N.attachEvent("on"+L,M)}}else{n("Document does not have required addEventListener or attachEvent method")}}h.util.addListener=i;var J=[];function c(L){return L.message||L.description||String(L)}function G(){if(h.initialized){return}var N;var U=false,O=false;if(C(document,"createRange")){N=document.createRange();if(k(N,q)&&g(N,a)){U=true}N.detach()}var Q=I(document);if(!Q||Q.nodeName.toLowerCase()!="body"){n("No body element found");return}if(Q&&C(Q,"createTextRange")){N=Q.createTextRange();if(z(N)){O=true}}if(!U&&!O){n("Neither Range nor TextRange are available");return}h.initialized=true;h.features={implementsDomRange:U,implementsTextRange:O};var M,S;for(var L in v){if((M=v[L]) instanceof x){M.init(M,h)}}for(var P=0,R=J.length;P<R;++P){try{J[P](h)}catch(T){S="Rangy init listener threw an exception. Continuing. Detail: "+c(T);E(S)}}}h.init=G;h.addInitListener=function(L){if(h.initialized){L(h)}else{J.push(L)}};var K=[];h.addCreateMissingNativeApiListener=function(L){K.push(L)};function s(N){N=N||window;G();for(var M=0,L=K.length;M<L;++M){K[M](N)}}h.createMissingNativeApi=s;function x(L,N,M){this.name=L;this.dependencies=N;this.initialized=false;this.supported=false;this.initializer=M}x.prototype={init:function(O){var P=this.dependencies||[];for(var N=0,L=P.length,Q,M;N<L;++N){M=P[N];Q=v[M];if(!Q||!(Q instanceof x)){throw new Error("required module '"+M+"' not found")}Q.init();if(!Q.supported){throw new Error("required module '"+M+"' not supported")}}this.initializer(this)},fail:function(L){this.initialized=true;this.supported=false;throw new Error("Module '"+this.name+"' failed to load: "+L)},warn:function(L){h.warn("Module "+this.name+": "+L)},deprecationNotice:function(L,M){h.warn("DEPRECATED: "+L+" in module "+this.name+"is deprecated. Please use "+M+" instead")},createError:function(L){return new Error("Error in Rangy "+this.name+" module: "+L)}};function r(L,M,O,P){var N=new x(M,O,function(S){if(!S.initialized){S.initialized=true;try{P(h,S);S.supported=true}catch(R){var Q="Module '"+M+"' failed to load: "+c(R);E(Q)}}});v[M]=N}h.createModule=function(L){var N,M;if(arguments.length==2){N=arguments[1];M=[]}else{N=arguments[2];M=arguments[1]}r(false,L,M,N)};h.createCoreModule=function(L,M,N){r(true,L,M,N)};function D(){}h.RangePrototype=D;h.rangePrototype=new D();function B(){}h.selectionPrototype=new B();var f=false;var H=function(L){if(!f){f=true;if(!h.initialized){G()}}};if(typeof window==A){n("No window found");return}if(typeof document==A){n("No document found");return}if(C(document,"addEventListener")){document.addEventListener("DOMContentLoaded",H,false)}i(window,"load",H);if(l){b.define(function(){h.amd=true;return h})}b.rangy=h})(this);rangy.createCoreModule("DomUtil",[],function(d,b){var t="undefined";var f=d.util;if(!f.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])){b.fail("document missing a Node creation method")}if(!f.isHostMethod(document,"getElementsByTagName")){b.fail("document missing getElementsByTagName method")}var F=document.createElement("div");if(!f.areHostMethods(F,["insertBefore","appendChild","cloneNode"]||!f.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"]))){b.fail("Incomplete Element implementation")}if(!f.isHostProperty(F,"innerHTML")){b.fail("Element is missing innerHTML property")}var H=document.createTextNode("test");if(!f.areHostMethods(H,["splitText","deleteData","insertData","appendData","cloneNode"]||!f.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"])||!f.areHostProperties(H,["data"]))){b.fail("Incomplete Text Node implementation")}var K=function(L,N){var M=L.length;while(M--){if(L[M]===N){return true}}return false};function h(M){var L;return typeof M.namespaceURI==t||((L=M.namespaceURI)===null||L=="http://www.w3.org/1999/xhtml")}function u(M){var L=M.parentNode;return(L.nodeType==1)?L:null}function o(M){var L=0;while((M=M.previousSibling)){++L}return L}function w(L){switch(L.nodeType){case 7:case 10:return 0;case 3:case 8:return L.length;default:return L.childNodes.length}}function l(M,L){var N=[],O;for(O=M;O;O=O.parentNode){N.push(O)}for(O=L;O;O=O.parentNode){if(K(N,O)){return O}}return null}function k(L,M,O){var N=O?M:M.parentNode;while(N){if(N===L){return true}else{N=N.parentNode}}return false}function D(L,M){return k(L,M,true)}function B(M,L,P){var N,O=P?M:M.parentNode;while(O){N=O.parentNode;if(N===L){return O}O=N}return null}function c(M){var L=M.nodeType;return L==3||L==4||L==8}function a(M){if(!M){return false}var L=M.nodeType;return L==3||L==8}function g(O,M){var L=M.nextSibling,N=M.parentNode;if(L){N.insertBefore(O,L)}else{N.appendChild(O)}return O}function v(Q,N,M){var P=Q.cloneNode(false);P.deleteData(0,N);Q.deleteData(N,Q.length-N);g(P,Q);if(M){for(var O=0,L;L=M[O++];){if(L.node==Q&&L.offset>N){L.node=P;L.offset-=N}else{if(L.node==Q.parentNode&&L.offset>o(Q)){++L.offset}}}}return P}function I(L){if(L.nodeType==9){return L}else{if(typeof L.ownerDocument!=t){return L.ownerDocument}else{if(typeof L.document!=t){return L.document}else{if(L.parentNode){return I(L.parentNode)}else{throw b.createError("getDocument: no document found for node")}}}}}function n(L){var M=I(L);if(typeof M.defaultView!=t){return M.defaultView}else{if(typeof M.parentWindow!=t){return M.parentWindow}else{throw b.createError("Cannot get a window object for node")}}}function J(L){if(typeof L.contentDocument!=t){return L.contentDocument}else{if(typeof L.contentWindow!=t){return L.contentWindow.document}else{throw b.createError("getIframeDocument: No Document object found for iframe element")}}}function G(L){if(typeof L.contentWindow!=t){return L.contentWindow}else{if(typeof L.contentDocument!=t){return L.contentDocument.defaultView}else{throw b.createError("getIframeWindow: No Window object found for iframe element")}}}function z(L){return L&&f.isHostMethod(L,"setTimeout")&&f.isHostObject(L,"document")}function y(O,M,L){var N;if(!O){N=document}else{if(f.isHostProperty(O,"nodeType")){N=(O.nodeType==1&&O.tagName.toLowerCase()=="iframe")?J(O):I(O)}else{if(z(O)){N=O.document}}}if(!N){throw M.createError(L+"(): Parameter must be a Window object or DOM node")}return N}function i(M){var L;while((L=M.parentNode)){M=L}return M}function C(O,Q,N,P){var L,R,T,S,M;if(O==N){return Q===P?0:(Q<P)?-1:1}else{if((L=B(N,O,true))){return Q<=o(L)?-1:1}else{if((L=B(O,N,true))){return o(L)<P?-1:1}else{R=l(O,N);if(!R){throw new Error("comparePoints error: nodes have no common ancestor")}T=(O===R)?R:B(O,R,true);S=(N===R)?R:B(N,R,true);if(T===S){throw b.createError("comparePoints got to case 4 and childA and childB are the same!")}else{M=R.firstChild;while(M){if(M===T){return -1}else{if(M===S){return 1}}M=M.nextSibling}}}}}}var r=false;function q(L){try{L.parentNode;return false}catch(M){return true}}(function(){var L=document.createElement("b");L.innerHTML="1";var M=L.firstChild;L.innerHTML="<br>";r=q(M);d.features.crashyTextNodes=r})();function s(L){if(!L){return"[No node]"}if(r&&q(L)){return"[Broken node]"}if(c(L)){return'"'+L.data+'"'}if(L.nodeType==1){var M=L.id?' id="'+L.id+'"':"";return"<"+L.nodeName+M+">["+o(L)+"]["+L.childNodes.length+"]["+(L.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return L.nodeName}function A(M){var L=I(M).createDocumentFragment(),N;while((N=M.firstChild)){L.appendChild(N)}return L}var m;if(typeof window.getComputedStyle!=t){m=function(L,M){return n(L).getComputedStyle(L,null)[M]}}else{if(typeof document.documentElement.currentStyle!=t){m=function(L,M){return L.currentStyle[M]}}else{b.fail("No means of obtaining computed style properties found")}}function e(L){this.root=L;this._next=L}e.prototype={_current:null,hasNext:function(){return !!this._next},next:function(){var N=this._current=this._next;var M,L;if(this._current){M=N.firstChild;if(M){this._next=M}else{L=null;while((N!==this.root)&&!(L=N.nextSibling)){N=N.parentNode}this._next=L}}return this._current},detach:function(){this._current=this._next=this.root=null}};function E(L){return new e(L)}function p(L,M){this.node=L;this.offset=M}p.prototype={equals:function(L){return !!L&&this.node===L.node&&this.offset==L.offset},inspect:function(){return"[DomPosition("+s(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}};function x(L){this.code=this[L];this.codeName=L;this.message="DOMException: "+this.codeName}x.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11};x.prototype.toString=function(){return this.message};d.dom={arrayContains:K,isHtmlNamespace:h,parentElement:u,getNodeIndex:o,getNodeLength:w,getCommonAncestor:l,isAncestorOf:k,isOrIsAncestorOf:D,getClosestAncestorIn:B,isCharacterDataNode:c,isTextOrCommentNode:a,insertAfter:g,splitDataNode:v,getDocument:I,getWindow:n,getIframeWindow:G,getIframeDocument:J,getBody:f.getBody,isWindow:z,getContentDocument:y,getRootContainer:i,comparePoints:C,isBrokenNode:q,inspectNode:s,getComputedStyleProperty:m,fragmentFromNodeChildren:A,createIterator:E,DomPosition:p};d.DOMException=x});rangy.createCoreModule("DomRange",["DomUtil"],function(p,aw){var t=p.dom;var aj=p.util;var I=t.DomPosition;var Z=p.DOMException;var M=t.isCharacterDataNode;var c=t.getNodeIndex;var L=t.isOrIsAncestorOf;var ax=t.getDocument;var al=t.comparePoints;var aq=t.splitDataNode;var ac=t.getClosestAncestorIn;var P=t.getNodeLength;var at=t.arrayContains;var u=t.getRootContainer;var x=p.features.crashyTextNodes;function af(ay,e){return(ay.nodeType!=3)&&(L(ay,e.startContainer)||L(ay,e.endContainer))}function am(e){return e.document||ax(e.startContainer)}function y(e){return new I(e.parentNode,c(e))}function h(e){return new I(e.parentNode,c(e)+1)}function d(ay,aA,az){var e=ay.nodeType==11?ay.firstChild:ay;if(M(aA)){if(az==aA.length){t.insertAfter(ay,aA)}else{aA.parentNode.insertBefore(ay,az==0?aA:aq(aA,az))}}else{if(az>=aA.childNodes.length){aA.appendChild(ay)}else{aA.insertBefore(ay,aA.childNodes[az])}}return e}function i(aA,az,e){a(aA);a(az);if(am(az)!=am(aA)){throw new Z("WRONG_DOCUMENT_ERR")}var aB=al(aA.startContainer,aA.startOffset,az.endContainer,az.endOffset),ay=al(aA.endContainer,aA.endOffset,az.startContainer,az.startOffset);return e?aB<=0&&ay>=0:aB<0&&ay>0}function q(az){var ay;for(var aA,aB=am(az.range).createDocumentFragment(),e;aA=az.next();){ay=az.isPartiallySelectedSubtree();aA=aA.cloneNode(!ay);if(ay){e=az.getSubtreeIterator();aA.appendChild(q(e));e.detach(true)}if(aA.nodeType==10){throw new Z("HIERARCHY_REQUEST_ERR")}aB.appendChild(aA)}return aB}function an(ay,aB,e){var az,aD;e=e||{stop:false};for(var aA,aC;aA=ay.next();){if(ay.isPartiallySelectedSubtree()){if(aB(aA)===false){e.stop=true;return}else{aC=ay.getSubtreeIterator();an(aC,aB,e);aC.detach(true);if(e.stop){return}}}else{az=t.createIterator(aA);while((aD=az.next())){if(aB(aD)===false){e.stop=true;return}}}}}function N(ay){var e;while(ay.next()){if(ay.isPartiallySelectedSubtree()){e=ay.getSubtreeIterator();N(e);e.detach(true)}else{ay.remove()}}}function ai(ay){for(var az,aA=am(ay.range).createDocumentFragment(),e;az=ay.next();){if(ay.isPartiallySelectedSubtree()){az=az.cloneNode(false);e=ay.getSubtreeIterator();az.appendChild(ai(e));e.detach(true)}else{ay.remove()}if(az.nodeType==10){throw new Z("HIERARCHY_REQUEST_ERR")}aA.appendChild(az)}return aA}function Q(az,e,aA){var aC=!!(e&&e.length),aB;var aD=!!aA;if(aC){aB=new RegExp("^("+e.join("|")+")$")}var ay=[];an(new w(az,false),function(aF){if(aC&&!aB.test(aF.nodeType)){return}if(aD&&!aA(aF)){return}var aG=az.startContainer;if(aF==aG&&M(aG)&&az.startOffset==aG.length){return}var aE=az.endContainer;if(aF==aE&&M(aE)&&az.endOffset==0){return}ay.push(aF)});return ay}function ap(e){var ay=(typeof e.getName=="undefined")?"Range":e.getName();return"["+ay+"("+t.inspectNode(e.startContainer)+":"+e.startOffset+", "+t.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function w(az,ay){this.range=az;this.clonePartiallySelectedTextNodes=ay;if(!az.collapsed){this.sc=az.startContainer;this.so=az.startOffset;this.ec=az.endContainer;this.eo=az.endOffset;var e=az.commonAncestorContainer;if(this.sc===this.ec&&M(this.sc)){this.isSingleCharacterDataNode=true;this._first=this._last=this._next=this.sc}else{this._first=this._next=(this.sc===e&&!M(this.sc))?this.sc.childNodes[this.so]:ac(this.sc,e,true);this._last=(this.ec===e&&!M(this.ec))?this.ec.childNodes[this.eo-1]:ac(this.ec,e,true)}}}w.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:false,reset:function(){this._current=null;this._next=this._first},hasNext:function(){return !!this._next},next:function(){var e=this._current=this._next;if(e){this._next=(e!==this._last)?e.nextSibling:null;if(M(e)&&this.clonePartiallySelectedTextNodes){if(e===this.ec){(e=e.cloneNode(true)).deleteData(this.eo,e.length-this.eo)}if(this._current===this.sc){(e=e.cloneNode(true)).deleteData(0,this.so)}}}return e},remove:function(){var ay=this._current,az,e;if(M(ay)&&(ay===this.sc||ay===this.ec)){az=(ay===this.sc)?this.so:0;e=(ay===this.ec)?this.eo:ay.length;if(az!=e){ay.deleteData(az,e-az)}}else{if(ay.parentNode){ay.parentNode.removeChild(ay)}else{}}},isPartiallySelectedSubtree:function(){var e=this._current;return af(e,this.range)},getSubtreeIterator:function(){var ay;if(this.isSingleCharacterDataNode){ay=this.range.cloneRange();ay.collapse(false)}else{ay=new C(am(this.range));var aC=this._current;var aA=aC,e=0,aB=aC,az=P(aC);if(L(aC,this.sc)){aA=this.sc;e=this.so}if(L(aC,this.ec)){aB=this.ec;az=this.eo}ae(ay,aA,e,aB,az)}return new w(ay,this.clonePartiallySelectedTextNodes)},detach:function(e){if(e){this.range.detach()}this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};function F(e){this.code=this[e];this.codeName=e;this.message="RangeException: "+this.codeName}F.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2};F.prototype.toString=function(){return this.message};var S=[1,3,4,5,7,8,10];var ak=[2,9,11];var k=[5,6,10,12];var A=[1,3,4,5,7,8,10,11];var au=[1,3,4,5,7,8];function n(e){return function(az,aB){var ay,aA=aB?az:az.parentNode;while(aA){ay=aA.nodeType;if(at(e,ay)){return aA}aA=aA.parentNode}return null}}var ar=n([9,11]);var H=n(k);var z=n([6,10,12]);function o(ay,e){if(z(ay,e)){throw new F("INVALID_NODE_TYPE_ERR")}}function s(e){if(!e.startContainer){throw new Z("INVALID_STATE_ERR")}}function b(e,ay){if(!at(ay,e.nodeType)){throw new F("INVALID_NODE_TYPE_ERR")}}function T(e,ay){if(ay<0||ay>(M(e)?e.length:e.childNodes.length)){throw new Z("INDEX_SIZE_ERR")}}function ab(ay,e){if(ar(ay,true)!==ar(e,true)){throw new Z("WRONG_DOCUMENT_ERR")}}function O(e){if(H(e,true)){throw new Z("NO_MODIFICATION_ALLOWED_ERR")}}function V(ay,e){if(!ay){throw new Z(e)}}function ad(e){return(x&&t.isBrokenNode(e))||!at(ak,e.nodeType)&&!ar(e,true)}function g(e,ay){return ay<=(M(e)?e.length:e.childNodes.length)}function D(e){return(!!e.startContainer&&!!e.endContainer&&!ad(e.startContainer)&&!ad(e.endContainer)&&g(e.startContainer,e.startOffset)&&g(e.endContainer,e.endOffset))}function a(e){s(e);if(!D(e)){throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}}var U=document.createElement("style");var K=false;try{U.innerHTML="<b>x</b>";K=(U.firstChild.nodeType==3)}catch(J){}p.features.htmlParsingConforms=K;var v=K?function(az){var ay=this.startContainer;var aA=ax(ay);if(!ay){throw new Z("INVALID_STATE_ERR")}var e=null;if(ay.nodeType==1){e=ay}else{if(M(ay)){e=t.parentElement(ay)}}if(e===null||(e.nodeName=="HTML"&&t.isHtmlNamespace(ax(e).documentElement)&&t.isHtmlNamespace(e))){e=aA.createElement("body")}else{e=e.cloneNode(false)}e.innerHTML=az;return t.fragmentFromNodeChildren(e)}:function(ay){s(this);var az=am(this);var e=az.createElement("body");e.innerHTML=ay;return t.fragmentFromNodeChildren(e)};function B(az,e){a(az);var aD=az.startContainer,aC=az.startOffset,aA=az.endContainer,ay=az.endOffset;var aB=(aD===aA);if(M(aA)&&ay>0&&ay<aA.length){aq(aA,ay,e)}if(M(aD)&&aC>0&&aC<aD.length){aD=aq(aD,aC,e);if(aB){ay-=aC;aA=aD}else{if(aA==aD.parentNode&&ay>=c(aD)){ay++}}aC=0}az.setStartAndEnd(aD,aC,aA,ay)}var W=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"];var aa=0,ag=1,m=2,f=3;var X=0,Y=1,ah=2,R=3;aj.extend(p.rangePrototype,{compareBoundaryPoints:function(aC,az){a(this);ab(this.startContainer,az.startContainer);var aE,ay,aD,e;var aB=(aC==f||aC==aa)?"start":"end";var aA=(aC==ag||aC==aa)?"start":"end";aE=this[aB+"Container"];ay=this[aB+"Offset"];aD=az[aA+"Container"];e=az[aA+"Offset"];return al(aE,ay,aD,e)},insertNode:function(ay){a(this);b(ay,A);O(this.startContainer);if(L(ay,this.startContainer)){throw new Z("HIERARCHY_REQUEST_ERR")}var e=d(ay,this.startContainer,this.startOffset);this.setStartBefore(e)},cloneContents:function(){a(this);var az,ay;if(this.collapsed){return am(this).createDocumentFragment()}else{if(this.startContainer===this.endContainer&&M(this.startContainer)){az=this.startContainer.cloneNode(true);az.data=az.data.slice(this.startOffset,this.endOffset);ay=am(this).createDocumentFragment();ay.appendChild(az);return ay}else{var e=new w(this,true);az=q(e);e.detach()}return az}},canSurroundContents:function(){a(this);O(this.startContainer);O(this.endContainer);var e=new w(this,true);var ay=(e._first&&(af(e._first,this))||(e._last&&af(e._last,this)));e.detach();return !ay},surroundContents:function(ay){b(ay,au);if(!this.canSurroundContents()){throw new F("BAD_BOUNDARYPOINTS_ERR")}var e=this.extractContents();if(ay.hasChildNodes()){while(ay.lastChild){ay.removeChild(ay.lastChild)}}d(ay,this.startContainer,this.startOffset);ay.appendChild(e);this.selectNode(ay)},cloneRange:function(){a(this);var e=new C(am(this));var ay=W.length,az;while(ay--){az=W[ay];e[az]=this[az]}return e},toString:function(){a(this);var az=this.startContainer;if(az===this.endContainer&&M(az)){return(az.nodeType==3||az.nodeType==4)?az.data.slice(this.startOffset,this.endOffset):""}else{var e=[],ay=new w(this,true);an(ay,function(aA){if(aA.nodeType==3||aA.nodeType==4){e.push(aA.data)}});ay.detach();return e.join("")}},compareNode:function(az){a(this);var ay=az.parentNode;var aB=c(az);if(!ay){throw new Z("NOT_FOUND_ERR")}var aA=this.comparePoint(ay,aB),e=this.comparePoint(ay,aB+1);if(aA<0){return(e>0)?ah:X}else{return(e>0)?Y:R}},comparePoint:function(e,ay){a(this);V(e,"HIERARCHY_REQUEST_ERR");ab(e,this.startContainer);if(al(e,ay,this.startContainer,this.startOffset)<0){return -1}else{if(al(e,ay,this.endContainer,this.endOffset)>0){return 1}}return 0},createContextualFragment:v,toHtml:function(){a(this);var e=this.commonAncestorContainer.parentNode.cloneNode(false);e.appendChild(this.cloneContents());return e.innerHTML},intersectsNode:function(aA,e){a(this);V(aA,"NOT_FOUND_ERR");if(ax(aA)!==am(this)){return false}var az=aA.parentNode,aC=c(aA);V(az,"NOT_FOUND_ERR");var aB=al(az,aC,this.endContainer,this.endOffset),ay=al(az,aC+1,this.startContainer,this.startOffset);return e?aB<=0&&ay>=0:aB<0&&ay>0},isPointInRange:function(e,ay){a(this);V(e,"HIERARCHY_REQUEST_ERR");ab(e,this.startContainer);return(al(e,ay,this.startContainer,this.startOffset)>=0)&&(al(e,ay,this.endContainer,this.endOffset)<=0)},intersectsRange:function(e){return i(this,e,false)},intersectsOrTouchesRange:function(e){return i(this,e,true)},intersection:function(e){if(this.intersectsRange(e)){var aA=al(this.startContainer,this.startOffset,e.startContainer,e.startOffset),ay=al(this.endContainer,this.endOffset,e.endContainer,e.endOffset);var az=this.cloneRange();if(aA==-1){az.setStart(e.startContainer,e.startOffset)}if(ay==1){az.setEnd(e.endContainer,e.endOffset)}return az}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var ay=this.cloneRange();if(al(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1){ay.setStart(e.startContainer,e.startOffset)}if(al(e.endContainer,e.endOffset,this.endContainer,this.endOffset)==1){ay.setEnd(e.endContainer,e.endOffset)}return ay}else{throw new F("Ranges do not intersect")}},containsNode:function(ay,e){if(e){return this.intersectsNode(ay,false)}else{return this.compareNode(ay)==R}},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,P(e))<=0},containsRange:function(e){var ay=this.intersection(e);return ay!==null&&e.equals(ay)},containsNodeText:function(aA){var aB=this.cloneRange();aB.selectNode(aA);var az=aB.getNodes([3]);if(az.length>0){aB.setStart(az[0],0);var e=az.pop();aB.setEnd(e,e.length);var ay=this.containsRange(aB);aB.detach();return ay}else{return this.containsNodeContents(aA)}},getNodes:function(e,ay){a(this);return Q(this,e,ay)},getDocument:function(){return am(this)},collapseBefore:function(e){s(this);this.setEndBefore(e);this.collapse(false)},collapseAfter:function(e){s(this);this.setStartAfter(e);this.collapse(true)},getBookmark:function(e){var aB=am(this);var az=p.createRange(aB);e=e||t.getBody(aB);az.selectNodeContents(e);var aA=this.intersection(az);var aC=0,ay=0;if(aA){az.setEnd(aA.startContainer,aA.startOffset);aC=az.toString().length;ay=aC+aA.toString().length;az.detach()}return{start:aC,end:ay,containerNode:e}},moveToBookmark:function(aE){var aA=aE.containerNode;var e=0;this.setStart(aA,0);this.collapse(true);var aC=[aA],ay,az=false,aF=false;var aD,aB,aG;while(!aF&&(ay=aC.pop())){if(ay.nodeType==3){aD=e+ay.length;if(!az&&aE.start>=e&&aE.start<=aD){this.setStart(ay,aE.start-e);az=true}if(az&&aE.end>=e&&aE.end<=aD){this.setEnd(ay,aE.end-e);aF=true}e=aD}else{aG=ay.childNodes;aB=aG.length;while(aB--){aC.push(aG[aB])}}}},getName:function(){return"DomRange"},equals:function(e){return C.rangesEqual(this,e)},isValid:function(){return D(this)},inspect:function(){return ap(this)}});function E(e){e.START_TO_START=aa;e.START_TO_END=ag;e.END_TO_END=m;e.END_TO_START=f;e.NODE_BEFORE=X;e.NODE_AFTER=Y;e.NODE_BEFORE_AND_AFTER=ah;e.NODE_INSIDE=R}function r(e){E(e);E(e.prototype)}function ao(e,ay){return function(){a(this);var aE=this.startContainer,aD=this.startOffset,az=this.commonAncestorContainer;var aB=new w(this,true);var aC,aF;if(aE!==az){aC=ac(aE,az,true);aF=h(aC);aE=aF.node;aD=aF.offset}an(aB,O);aB.reset();var aA=e(aB);aB.detach();ay(this,aE,aD,aE,aD);return aA}}function l(az,aD,e){function aC(aF,aE){return function(aG){s(this);b(aG,S);b(u(aG),ak);var aH=(aF?y:h)(aG);(aE?ay:aB)(this,aH.node,aH.offset)}}function ay(aF,aH,aI){var aG=aF.endContainer,aE=aF.endOffset;if(aH!==aF.startContainer||aI!==aF.startOffset){if(u(aH)!=u(aG)||al(aH,aI,aG,aE)==1){aG=aH;aE=aI}aD(aF,aH,aI,aG,aE)}}function aB(aE,aF,aI){var aH=aE.startContainer,aG=aE.startOffset;if(aF!==aE.endContainer||aI!==aE.endOffset){if(u(aF)!=u(aH)||al(aF,aI,aH,aG)==-1){aH=aF;aG=aI}aD(aE,aH,aG,aF,aI)}}var aA=function(){};aA.prototype=p.rangePrototype;az.prototype=new aA();aj.extend(az.prototype,{setStart:function(aE,aF){s(this);o(aE,true);T(aE,aF);ay(this,aE,aF)},setEnd:function(aE,aF){s(this);o(aE,true);T(aE,aF);aB(this,aE,aF)},setStartAndEnd:function(){s(this);var aG=arguments;var aI=aG[0],aH=aG[1],aF=aI,aE=aH;switch(aG.length){case 3:aE=aG[2];break;case 4:aF=aG[2];aE=aG[3];break}aD(this,aI,aH,aF,aE)},setBoundary:function(aF,aG,aE){this["set"+(aE?"Start":"End")](aF,aG)},setStartBefore:aC(true,true),setStartAfter:aC(false,true),setEndBefore:aC(true,false),setEndAfter:aC(false,false),collapse:function(aE){a(this);if(aE){aD(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset)}else{aD(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)}},selectNodeContents:function(aE){s(this);o(aE,true);aD(this,aE,0,aE,P(aE))},selectNode:function(aF){s(this);o(aF,false);b(aF,S);var aG=y(aF),aE=h(aF);aD(this,aG.node,aG.offset,aE.node,aE.offset)},extractContents:ao(ai,aD),deleteContents:ao(N,aD),canSurroundContents:function(){a(this);O(this.startContainer);O(this.endContainer);var aE=new w(this,true);var aF=(aE._first&&(af(aE._first,this))||(aE._last&&af(aE._last,this)));aE.detach();return !aF},detach:function(){e(this)},splitBoundaries:function(){B(this)},splitBoundariesPreservingPositions:function(aE){B(this,aE)},normalizeBoundaries:function(){a(this);var aL=this.startContainer,aG=this.startOffset,aK=this.endContainer,aE=this.endOffset;var aH=function(aO){var aN=aO.nextSibling;if(aN&&aN.nodeType==aO.nodeType){aK=aO;aE=aO.length;aO.appendData(aN.data);aN.parentNode.removeChild(aN)}};var aM=function(aP){var aO=aP.previousSibling;if(aO&&aO.nodeType==aP.nodeType){aL=aP;var aN=aP.length;aG=aO.length;aP.insertData(0,aO.data);aO.parentNode.removeChild(aO);if(aL==aK){aE+=aG;aK=aL}else{if(aK==aP.parentNode){var aQ=c(aP);if(aE==aQ){aK=aP;aE=aN}else{if(aE>aQ){aE--}}}}}};var aJ=true;if(M(aK)){if(aK.length==aE){aH(aK)}}else{if(aE>0){var aI=aK.childNodes[aE-1];if(aI&&M(aI)){aH(aI)}}aJ=!this.collapsed}if(aJ){if(M(aL)){if(aG==0){aM(aL)}}else{if(aG<aL.childNodes.length){var aF=aL.childNodes[aG];if(aF&&M(aF)){aM(aF)}}}}else{aL=aK;aG=aE}aD(this,aL,aG,aK,aE)},collapseToPoint:function(aE,aF){s(this);o(aE,true);T(aE,aF);this.setStartAndEnd(aE,aF)}});r(az)}function G(e){e.collapsed=(e.startContainer===e.endContainer&&e.startOffset===e.endOffset);e.commonAncestorContainer=e.collapsed?e.startContainer:t.getCommonAncestor(e.startContainer,e.endContainer)}function ae(ay,aA,e,aB,az){ay.startContainer=aA;ay.startOffset=e;ay.endContainer=aB;ay.endOffset=az;ay.document=t.getDocument(aA);G(ay)}function av(e){s(e);e.startContainer=e.startOffset=e.endContainer=e.endOffset=e.document=null;e.collapsed=e.commonAncestorContainer=null}function C(e){this.startContainer=e;this.startOffset=0;this.endContainer=e;this.endOffset=0;this.document=e;G(this)}l(C,ae,av);aj.extend(C,{rangeProperties:W,RangeIterator:w,copyComparisonConstants:r,createPrototypeRange:l,inspect:ap,getRangeDocument:am,rangesEqual:function(ay,e){return ay.startContainer===e.startContainer&&ay.startOffset===e.startOffset&&ay.endContainer===e.endContainer&&ay.endOffset===e.endOffset}});p.DomRange=C;p.RangeException=F});rangy.createCoreModule("WrappedRange",["DomRange"],function(n,e){var a,b;var i=n.dom;var k=n.util;var d=i.DomPosition;var o=n.DomRange;var l=i.getBody;var q=i.getContentDocument;var m=i.isCharacterDataNode;if(n.features.implementsDomRange){(function(){var u;var B=o.rangeProperties;function r(E){var F=B.length,G;while(F--){G=B[F];E[G]=E.nativeRange[G]}E.collapsed=(E.startContainer===E.endContainer&&E.startOffset===E.endOffset)}function w(G,J,F,K,H){var E=(G.startContainer!==J||G.startOffset!=F);var L=(G.endContainer!==K||G.endOffset!=H);var I=!G.equals(G.nativeRange);if(E||L||I){G.setEnd(K,H);G.setStart(J,F)}}function C(E){E.nativeRange.detach();E.detached=true;var F=B.length;while(F--){E[B[F]]=null}}var t;a=function(E){if(!E){throw e.createError("WrappedRange: Range must be specified")}this.nativeRange=E;r(this)};o.createPrototypeRange(a,w,C);u=a.prototype;u.selectNode=function(E){this.nativeRange.selectNode(E);r(this)};u.cloneContents=function(){return this.nativeRange.cloneContents()};u.surroundContents=function(E){this.nativeRange.surroundContents(E);r(this)};u.collapse=function(E){this.nativeRange.collapse(E);r(this)};u.cloneRange=function(){return new a(this.nativeRange.cloneRange())};u.refresh=function(){r(this)};u.toString=function(){return this.nativeRange.toString()};var A=document.createTextNode("test");l(document).appendChild(A);var x=document.createRange();x.setStart(A,0);x.setEnd(A,0);try{x.setStart(A,1);u.setStart=function(E,F){this.nativeRange.setStart(E,F);r(this)};u.setEnd=function(E,F){this.nativeRange.setEnd(E,F);r(this)};t=function(E){return function(F){this.nativeRange[E](F);r(this)}}}catch(z){u.setStart=function(F,G){try{this.nativeRange.setStart(F,G)}catch(E){this.nativeRange.setEnd(F,G);this.nativeRange.setStart(F,G)}r(this)};u.setEnd=function(F,G){try{this.nativeRange.setEnd(F,G)}catch(E){this.nativeRange.setStart(F,G);this.nativeRange.setEnd(F,G)}r(this)};t=function(E,F){return function(H){try{this.nativeRange[E](H)}catch(G){this.nativeRange[F](H);this.nativeRange[E](H)}r(this)}}}u.setStartBefore=t("setStartBefore","setEndBefore");u.setStartAfter=t("setStartAfter","setEndAfter");u.setEndBefore=t("setEndBefore","setStartBefore");u.setEndAfter=t("setEndAfter","setStartAfter");u.selectNodeContents=function(E){this.setStartAndEnd(E,0,i.getNodeLength(E))};x.selectNodeContents(A);x.setEnd(A,3);var D=document.createRange();D.selectNodeContents(A);D.setEnd(A,4);D.setStart(A,2);if(x.compareBoundaryPoints(x.START_TO_END,D)==-1&&x.compareBoundaryPoints(x.END_TO_START,D)==1){u.compareBoundaryPoints=function(F,E){E=E.nativeRange||E;if(F==E.START_TO_END){F=E.END_TO_START}else{if(F==E.END_TO_START){F=E.START_TO_END}}return this.nativeRange.compareBoundaryPoints(F,E)}}else{u.compareBoundaryPoints=function(F,E){return this.nativeRange.compareBoundaryPoints(F,E.nativeRange||E)}}var s=document.createElement("div");s.innerHTML="123";var v=s.firstChild;var y=l(document);y.appendChild(s);x.setStart(v,1);x.setEnd(v,2);x.deleteContents();if(v.data=="13"){u.deleteContents=function(){this.nativeRange.deleteContents();r(this)};u.extractContents=function(){var E=this.nativeRange.extractContents();r(this);return E}}else{}y.removeChild(s);y=null;if(k.isHostMethod(x,"createContextualFragment")){u.createContextualFragment=function(E){return this.nativeRange.createContextualFragment(E)}}l(document).removeChild(A);x.detach();D.detach();u.getName=function(){return"WrappedRange"};n.WrappedRange=a;n.createNativeRange=function(E){E=q(E,e,"createNativeRange");return E.createRange()}})()}if(n.features.implementsTextRange){var f=function(w){var u=w.parentElement();var s=w.duplicate();s.collapse(true);var v=s.parentElement();s=w.duplicate();s.collapse(false);var t=s.parentElement();var r=(v==t)?v:i.getCommonAncestor(v,t);return r==u?r:i.getCommonAncestor(u,r)};var c=function(r){return r.compareEndPoints("StartToEnd",r)==0};var g=function(r,D,B,s,v){var E=r.duplicate();E.collapse(B);var t=E.parentElement();if(!i.isOrIsAncestorOf(D,t)){t=D}if(!t.canHaveHTML){var A=new d(t.parentNode,i.getNodeIndex(t));return{boundaryPosition:A,nodeInfo:{nodeIndex:A.offset,containerElement:A.node}}}var u=i.getDocument(t).createElement("span");if(u.parentNode){u.parentNode.removeChild(u)}var M,K=B?"StartToStart":"StartToEnd";var F,w,C,G;var y=(v&&v.containerElement==t)?v.nodeIndex:0;var H=t.childNodes.length;var x=H;var J=x;while(true){if(J==H){t.appendChild(u)}else{t.insertBefore(u,t.childNodes[J])}E.moveToElementText(u);M=E.compareEndPoints(K,r);if(M==0||y==x){break}else{if(M==-1){if(x==y+1){break}else{y=J}}else{x=(x==y+1)?y:J}}J=Math.floor((y+x)/2);t.removeChild(u)}G=u.nextSibling;if(M==-1&&G&&m(G)){E.setEndPoint(B?"EndToStart":"EndToEnd",r);var z;if(/[\r\n]/.test(G.data)){var I=E.duplicate();var L=I.text.replace(/\r\n/g,"\r").length;z=I.moveStart("character",L);while((M=I.compareEndPoints("StartToEnd",I))==-1){z++;I.moveStart("character",1)}}else{z=E.text.length}C=new d(G,z)}else{F=(s||!B)&&u.previousSibling;w=(s||B)&&u.nextSibling;if(w&&m(w)){C=new d(w,0)}else{if(F&&m(F)){C=new d(F,F.data.length)}else{C=new d(t,i.getNodeIndex(u))}}}u.parentNode.removeChild(u);return{boundaryPosition:C,nodeInfo:{nodeIndex:J,containerElement:t}}};var p=function(r,t){var u,x,v=r.offset;var y=i.getDocument(r.node);var s,z,A=l(y).createTextRange();var w=m(r.node);if(w){u=r.node;x=u.parentNode}else{z=r.node.childNodes;u=(v<z.length)?z[v]:null;x=r.node}s=y.createElement("span");s.innerHTML="&#feff;";if(u){x.insertBefore(s,u)}else{x.appendChild(s)}A.moveToElementText(s);A.collapse(!t);x.removeChild(s);if(w){A[t?"moveStart":"moveEnd"]("character",v)}return A};b=function(r){this.textRange=r;this.refresh()};b.prototype=new o(document);b.prototype.refresh=function(){var u,r,t;var s=f(this.textRange);if(c(this.textRange)){r=u=g(this.textRange,s,true,true).boundaryPosition}else{t=g(this.textRange,s,true,false);u=t.boundaryPosition;r=g(this.textRange,s,false,false,t.nodeInfo).boundaryPosition}this.setStart(u.node,u.offset);this.setEnd(r.node,r.offset)};b.prototype.getName=function(){return"WrappedTextRange"};o.copyComparisonConstants(b);b.rangeToTextRange=function(r){if(r.collapsed){return p(new d(r.startContainer,r.startOffset),true)}else{var u=p(new d(r.startContainer,r.startOffset),true);var t=p(new d(r.endContainer,r.endOffset),false);var s=l(o.getRangeDocument(r)).createTextRange();s.setEndPoint("StartToStart",u);s.setEndPoint("EndToEnd",t);return s}};n.WrappedTextRange=b;if(!n.features.implementsDomRange||n.config.preferTextRange){var h=(function(){return this})();if(typeof h.Range=="undefined"){h.Range=b}n.createNativeRange=function(r){r=q(r,e,"createNativeRange");return l(r).createTextRange()};n.WrappedRange=b}}n.createRange=function(r){r=q(r,e,"createRange");return new n.WrappedRange(n.createNativeRange(r))};n.createRangyRange=function(r){r=q(r,e,"createRangyRange");return new o(r)};n.createIframeRange=function(r){e.deprecationNotice("createIframeRange()","createRange(iframeEl)");return n.createRange(r)};n.createIframeRangyRange=function(r){e.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)");return n.createRangyRange(r)};n.addCreateMissingNativeApiListener(function(s){var r=s.document;if(typeof r.createRange=="undefined"){r.createRange=function(){return n.createRange(r)}}r=s=null})});rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(k,d){k.config.checkSelectionRanges=true;var J="boolean";var M="number";var c=k.dom;var p=k.util;var X=p.isHostMethod;var ab=k.DomRange;var f=k.WrappedRange;var W=k.DOMException;var E=c.DomPosition;var T;var r;var o=k.features;var aj="Control";var ai=c.getDocument;var ah=c.getBody;var O=ab.rangesEqual;function g(al){return(typeof al=="string")?/^backward(s)?$/i.test(al):!!al}function A(an,al){if(!an){return window}else{if(c.isWindow(an)){return an}else{if(an instanceof G){return an.win}else{var am=c.getContentDocument(an,d,al);return c.getWindow(am)}}}}function q(al){return A(al,"getWinSelection").getSelection()}function u(al){return A(al,"getDocSelection").document.selection}function ag(al){var am=false;if(al.anchorNode){am=(c.comparePoints(al.anchorNode,al.anchorOffset,al.focusNode,al.focusOffset)==1)}return am}var ae=X(window,"getSelection"),V=p.isHostObject(document,"selection");o.implementsWinGetSelection=ae;o.implementsDocSelection=V;var x=V&&(!ae||k.config.preferTextRange);if(x){T=u;k.isSelectionValid=function(am){var an=A(am,"isSelectionValid").document,al=an.selection;return(al.type!="None"||ai(al.createRange().parentElement())==an)}}else{if(ae){T=q;k.isSelectionValid=function(){return true}}else{d.fail("Neither document.selection or window.getSelection() detected.")}}k.getNativeSelection=T;var U=T();var H=k.createNativeRange(document);var I=ah(document);var R=p.areHostProperties(U,["anchorNode","focusNode","anchorOffset","focusOffset"]);o.selectionHasAnchorAndFocus=R;var t=X(U,"extend");o.selectionHasExtend=t;var ak=(typeof U.rangeCount==M);o.selectionHasRangeCount=ak;var aa=false;var Y=true;var B=t?function(ao,al){var an=ab.getRangeDocument(al);var am=k.createRange(an);am.collapseToPoint(al.endContainer,al.endOffset);ao.addRange(Q(am));ao.extend(al.startContainer,al.startOffset)}:null;if(p.areHostMethods(U,["addRange","getRangeAt","removeAllRanges"])&&typeof U.rangeCount==M&&o.implementsDomRange){(function(){var am=window.getSelection();if(am){var aq=am.rangeCount;var at=(aq>1);var av=[];var aw=ag(am);for(var ar=0;ar<aq;++ar){av[ar]=am.getRangeAt(ar)}var au=ah(document);var ap=au.appendChild(document.createElement("div"));ap.contentEditable="false";var ao=ap.appendChild(document.createTextNode("\u00a0\u00a0\u00a0"));var an=document.createRange();an.setStart(ao,1);an.collapse(true);am.addRange(an);Y=(am.rangeCount==1);am.removeAllRanges();if(!at){var al=an.cloneRange();an.setStart(ao,0);al.setEnd(ao,3);al.setStart(ao,2);am.addRange(an);am.addRange(al);aa=(am.rangeCount==2);al.detach()}au.removeChild(ap);am.removeAllRanges();an.detach();for(ar=0;ar<aq;++ar){if(ar==0&&aw){if(B){B(am,av[ar])}else{k.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because browser does not support Selection.extend");am.addRange(av[ar])}}else{am.addRange(av[ar])}}}})()}o.selectionSupportsMultipleRanges=aa;o.collapsedNonEditableSelectionsSupported=Y;var i=false,m;if(I&&X(I,"createControlRange")){m=I.createControlRange();if(p.areHostProperties(m,["item","add"])){i=true}}o.implementsControlRange=i;if(R){r=function(al){return al.anchorNode===al.focusNode&&al.anchorOffset===al.focusOffset}}else{r=function(al){return al.rangeCount?al.getRangeAt(al.rangeCount-1).collapsed:false}}function b(an,al,ao){var am=ao?"end":"start",ap=ao?"start":"end";an.anchorNode=al[am+"Container"];an.anchorOffset=al[am+"Offset"];an.focusNode=al[ap+"Container"];an.focusOffset=al[ap+"Offset"]}function z(am){var al=am.nativeSelection;am.anchorNode=al.anchorNode;am.anchorOffset=al.anchorOffset;am.focusNode=al.focusNode;am.focusOffset=al.focusOffset}function N(al){al.anchorNode=al.focusNode=null;al.anchorOffset=al.focusOffset=0;al.rangeCount=0;al.isCollapsed=true;al._ranges.length=0}function Q(al){var am;if(al instanceof ab){am=k.createNativeRange(al.getDocument());am.setEnd(al.endContainer,al.endOffset);am.setStart(al.startContainer,al.startOffset)}else{if(al instanceof f){am=al.nativeRange}else{if(o.implementsDomRange&&(al instanceof c.getWindow(al.startContainer).Range)){am=al}}}return am}function n(an){if(!an.length||an[0].nodeType!=1){return false}for(var am=1,al=an.length;am<al;++am){if(!c.isAncestorOf(an[0],an[am])){return false}}return true}function S(am){var al=am.getNodes();if(!n(al)){throw d.createError("getSingleElementFromRange: range "+am.inspect()+" did not consist of a single element")}return al[0]}function L(al){return !!al&&typeof al.text!="undefined"}function P(an,am){var al=new f(am);an._ranges=[al];b(an,al,false);an.rangeCount=1;an.isCollapsed=al.collapsed}function w(ao){ao._ranges.length=0;if(ao.docSelection.type=="None"){N(ao)}else{var an=ao.docSelection.createRange();if(L(an)){P(ao,an)}else{ao.rangeCount=an.length;var al,ap=ai(an.item(0));for(var am=0;am<ao.rangeCount;++am){al=k.createRange(ap);al.selectNode(an.item(am));ao._ranges.push(al)}ao.isCollapsed=ao.rangeCount==1&&ao._ranges[0].collapsed;b(ao,ao._ranges[ao.rangeCount-1],false)}}}function D(am,ap){var an=am.docSelection.createRange();var al=S(ap);var au=ai(an.item(0));var aq=ah(au).createControlRange();for(var ao=0,ar=an.length;ao<ar;++ao){aq.add(an.item(ao))}try{aq.add(al)}catch(at){throw d.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}aq.select();w(am)}var s;if(X(U,"getRangeAt")){s=function(an,al){try{return an.getRangeAt(al)}catch(am){return null}}}else{if(R){s=function(am){var an=ai(am.anchorNode);var al=k.createRange(an);al.setStartAndEnd(am.anchorNode,am.anchorOffset,am.focusNode,am.focusOffset);if(al.collapsed!==this.isCollapsed){al.setStartAndEnd(am.focusNode,am.focusOffset,am.anchorNode,am.anchorOffset)}return al}}}function G(al,an,am){this.nativeSelection=al;this.docSelection=an;this._ranges=[];this.win=am;this.refresh()}G.prototype=k.selectionPrototype;function C(al){al.win=al.anchorNode=al.focusNode=al._ranges=null;al.rangeCount=al.anchorOffset=al.focusOffset=0;al.detached=true}var af=[];function Z(ap,ao){var al=af.length,am,an;while(al--){am=af[al];an=am.selection;if(ao=="deleteAll"){C(an)}else{if(am.win==ap){if(ao=="delete"){af.splice(al,1);return true}else{return an}}}}if(ao=="deleteAll"){af.length=0}return null}var y=function(an){if(an&&an instanceof G){an.refresh();return an}an=A(an,"getNativeSelection");var am=Z(an);var al=T(an),ao=V?u(an):null;if(am){am.nativeSelection=al;am.docSelection=ao;am.refresh()}else{am=new G(al,ao,an);af.push({win:an,selection:am})}return am};k.getSelection=y;k.getIframeSelection=function(al){d.deprecationNotice("getIframeSelection()","getSelection(iframeEl)");return k.getSelection(c.getIframeWindow(al))};var a=G.prototype;function l(ar,am){var at=ai(am[0].startContainer);var ap=ah(at).createControlRange();for(var ao=0,aq,al=am.length;ao<al;++ao){aq=S(am[ao]);try{ap.add(aq)}catch(an){throw d.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}ap.select();w(ar)}if(!x&&R&&p.areHostMethods(U,["removeAllRanges","addRange"])){a.removeAllRanges=function(){this.nativeSelection.removeAllRanges();N(this)};var e=function(am,al){B(am.nativeSelection,al);am.refresh()};if(ak){a.addRange=function(al,ao){if(i&&V&&this.docSelection.type==aj){D(this,al)}else{if(g(ao)&&t){e(this,al)}else{var am;if(aa){am=this.rangeCount}else{this.removeAllRanges();am=0}this.nativeSelection.addRange(Q(al).cloneRange());this.rangeCount=this.nativeSelection.rangeCount;if(this.rangeCount==am+1){if(k.config.checkSelectionRanges){var an=s(this.nativeSelection,this.rangeCount-1);if(an&&!O(an,al)){al=new f(an)}}this._ranges[this.rangeCount-1]=al;b(this,al,h(this.nativeSelection));this.isCollapsed=r(this)}else{this.refresh()}}}}}else{a.addRange=function(al,am){if(g(am)&&t){e(this,al)}else{this.nativeSelection.addRange(Q(al));this.refresh()}}}a.setRanges=function(am){if(i&&am.length>1){l(this,am)}else{this.removeAllRanges();for(var an=0,al=am.length;an<al;++an){this.addRange(am[an])}}}}else{if(X(U,"empty")&&X(H,"select")&&i&&x){a.removeAllRanges=function(){try{this.docSelection.empty();if(this.docSelection.type!="None"){var ao;if(this.anchorNode){ao=ai(this.anchorNode)}else{if(this.docSelection.type==aj){var am=this.docSelection.createRange();if(am.length){ao=ai(am.item(0))}}}if(ao){var an=ah(ao).createTextRange();an.select();this.docSelection.empty()}}}catch(al){}N(this)};a.addRange=function(al){if(this.docSelection.type==aj){D(this,al)}else{k.WrappedTextRange.rangeToTextRange(al).select();this._ranges[0]=al;this.rangeCount=1;this.isCollapsed=this._ranges[0].collapsed;b(this,al,false)}};a.setRanges=function(al){this.removeAllRanges();var am=al.length;if(am>1){l(this,al)}else{if(am){this.addRange(al[0])}}}}else{d.fail("No means of selecting a Range or TextRange was found");return false}}a.getRangeAt=function(al){if(al<0||al>=this.rangeCount){throw new W("INDEX_SIZE_ERR")}else{return this._ranges[al].cloneRange()}};var K;if(x){K=function(am){var al;if(k.isSelectionValid(am.win)){al=am.docSelection.createRange()}else{al=ah(am.win.document).createTextRange();al.collapse(true)}if(am.docSelection.type==aj){w(am)}else{if(L(al)){P(am,al)}else{N(am)}}}}else{if(X(U,"getRangeAt")&&typeof U.rangeCount==M){K=function(an){if(i&&V&&an.docSelection.type==aj){w(an)}else{an._ranges.length=an.rangeCount=an.nativeSelection.rangeCount;if(an.rangeCount){for(var am=0,al=an.rangeCount;am<al;++am){an._ranges[am]=new k.WrappedRange(an.nativeSelection.getRangeAt(am))}b(an,an._ranges[an.rangeCount-1],h(an.nativeSelection));an.isCollapsed=r(an)}else{N(an)}}}}else{if(R&&typeof U.isCollapsed==J&&typeof H.collapsed==J&&o.implementsDomRange){K=function(an){var al,am=an.nativeSelection;if(am.anchorNode){al=s(am,0);an._ranges=[al];an.rangeCount=1;z(an);an.isCollapsed=r(an)}else{N(an)}}}else{d.fail("No means of obtaining a Range or TextRange from the user's selection was found");return false}}}a.refresh=function(am){var al=am?this._ranges.slice(0):null;var ao=this.anchorNode,ap=this.anchorOffset;K(this);if(am){var an=al.length;if(an!=this._ranges.length){return true}if(this.anchorNode!=ao||this.anchorOffset!=ap){return true}while(an--){if(!O(al[an],this._ranges[an])){return true}}return false}};var F=function(ap,an){var am=ap.getAllRanges();ap.removeAllRanges();for(var ao=0,al=am.length;ao<al;++ao){if(!O(an,am[ao])){ap.addRange(am[ao])}}if(!ap.rangeCount){N(ap)}};if(i){a.removeRange=function(ap){if(this.docSelection.type==aj){var an=this.docSelection.createRange();var al=S(ap);var au=ai(an.item(0));var ar=ah(au).createControlRange();var am,at=false;for(var ao=0,aq=an.length;ao<aq;++ao){am=an.item(ao);if(am!==al||at){ar.add(an.item(ao))}else{at=true}}ar.select();w(this)}else{F(this,ap)}}}else{a.removeRange=function(al){F(this,al)}}var h;if(!x&&R&&o.implementsDomRange){h=ag;a.isBackward=function(){return h(this)}}else{h=a.isBackward=function(){return false}}a.isBackwards=a.isBackward;a.toString=function(){var an=[];for(var am=0,al=this.rangeCount;am<al;++am){an[am]=""+this._ranges[am]}return an.join("")};function ac(am,al){if(am.win.document!=ai(al)){throw new W("WRONG_DOCUMENT_ERR")}}a.collapse=function(am,an){ac(this,am);var al=k.createRange(am);al.collapseToPoint(am,an);this.setSingleRange(al);this.isCollapsed=true};a.collapseToStart=function(){if(this.rangeCount){var al=this._ranges[0];this.collapse(al.startContainer,al.startOffset)}else{throw new W("INVALID_STATE_ERR")}};a.collapseToEnd=function(){if(this.rangeCount){var al=this._ranges[this.rangeCount-1];this.collapse(al.endContainer,al.endOffset)}else{throw new W("INVALID_STATE_ERR")}};a.selectAllChildren=function(am){ac(this,am);var al=k.createRange(am);al.selectNodeContents(am);this.setSingleRange(al)};a.deleteFromDocument=function(){if(i&&V&&this.docSelection.type==aj){var ap=this.docSelection.createRange();var ao;while(ap.length){ao=ap.item(0);ap.remove(ao);ao.parentNode.removeChild(ao)}this.refresh()}else{if(this.rangeCount){var am=this.getAllRanges();if(am.length){this.removeAllRanges();for(var an=0,al=am.length;an<al;++an){am[an].deleteContents()}this.addRange(am[al-1])}}}};a.eachRange=function(ao,an){for(var am=0,al=this._ranges.length;am<al;++am){if(ao(this.getRangeAt(am))){return an}}};a.getAllRanges=function(){var al=[];this.eachRange(function(am){al.push(am)});return al};a.setSingleRange=function(al,am){this.removeAllRanges();this.addRange(al,am)};a.callMethodOnEachRange=function(al,an){var am=[];this.eachRange(function(ao){am.push(ao[al].apply(ao,an))});return am};function ad(al){return function(an,ao){var am;if(this.rangeCount){am=this.getRangeAt(0);am["set"+(al?"Start":"End")](an,ao)}else{am=k.createRange(this.win.document);am.setStartAndEnd(an,ao)}this.setSingleRange(am,this.isBackward())}}a.setStart=ad(true);a.setEnd=ad(false);k.rangePrototype.select=function(al){y(this.getDocument()).setSingleRange(this,al)};a.changeEachRange=function(am){var al=[];var an=this.isBackward();this.eachRange(function(ao){am(ao);al.push(ao)});this.removeAllRanges();if(an&&al.length==1){this.addRange(al[0],"backward")}else{this.setRanges(al)}};a.containsNode=function(am,al){return this.eachRange(function(an){return an.containsNode(am,al)},true)};a.getBookmark=function(al){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[al])}};a.moveToBookmark=function(ap){var al=[];for(var ao=0,an,am;an=ap.rangeBookmarks[ao++];){am=k.createRange(this.win);am.moveToBookmark(an);al.push(am)}if(ap.backward){this.setSingleRange(al[0],"backward")}else{this.setRanges(al)}};a.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")};function v(ar){var aq=[];var ao=new E(ar.anchorNode,ar.anchorOffset);var am=new E(ar.focusNode,ar.focusOffset);var an=(typeof ar.getName=="function")?ar.getName():"Selection";if(typeof ar.rangeCount!="undefined"){for(var ap=0,al=ar.rangeCount;ap<al;++ap){aq[ap]=ab.inspect(ar.getRangeAt(ap))}}return"["+an+"(Ranges: "+aq.join(", ")+")(anchor: "+ao.inspect()+", focus: "+am.inspect()+"]"}a.getName=function(){return"WrappedSelection"};a.inspect=function(){return v(this)};a.detach=function(){Z(this.win,"delete");C(this)};G.detachAll=function(){Z(null,"deleteAll")};G.inspect=v;G.isDirectionBackward=g;k.Selection=G;k.selectionPrototype=a;k.addCreateMissingNativeApiListener(function(al){if(typeof al.getSelection=="undefined"){al.getSelection=function(){return y(al)}}al=null})});(function(){function d(f){return f}var a=this,c,b;c={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",time:"data-time",changeData:"data-changedata",},attrValuePrefix:"",blockEl:"p",blockEls:["div","p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:false,contentEditable:undefined,_isTracking:true,noTrack:".ice-no-track",tooltips:false,tooltipsDelay:200,mergeBlocks:true,_isVisible:true,_changeData:null,_handleSelectAll:false,};b=function(f){f||(f={});if(!f.element){throw new Error("`options.element` must be defined for ice construction.")}this._changes={};this._userStyles={};this._styles={};this._refreshInterval=null;this.$this=jQuery(this);this._browser=ice.dom.browser();this._tooltipMouseOver=this._tooltipMouseOver.bind(this);this._tooltipMouseOut=this._tooltipMouseOut.bind(this);ice.dom.extend(true,this,c,f);if(f.tooltips&&(!jQuery.isFunction(f.hostMethods.showTooltip)||!jQuery.isFunction(f.hostMethods.hideTooltip))){throw new Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true")}var g=f.userStyles||{};for(var h in g){if(g.hasOwnProperty(h)){var e=g[h];if(!isNaN(e)){this._userStyles[h]=this.stylePrefix+"-"+e;this._uniqueStyleIndex=Math.max(e,this._uniqueStyleIndex);this._styles[e]=true}}}};b.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeid:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:false,startTracking:function(){if(typeof(this.contentEditable)=="boolean"){this.element.setAttribute("contentEditable",this.contentEditable)}if(this.handleEvents){var e=this;ice.dom.bind(e.element,"keyup.ice keydown.ice keypress.ice",function(f){return e.handleEvent(f)})}this.initializeEnvironment();this.initializeEditor();this.initializeRange();this._updateTooltipsState();return this},stopTracking:function(g){this._isTracking=false;try{if(this.element){ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice")}if(!g&&(typeof(this.contentEditable)!="undefined")){this.element.setAttribute("contentEditable",!this.contentEditable)}}catch(f){}this._updateTooltipsState();return this},initializeEnvironment:function(){this.env||(this.env={});this.env.element=this.element;this.env.document=this.element.ownerDocument;this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window;this.env.frame=this.env.window.frameElement;this.env.selection=this.selection=new ice.Selection(this.env);this.env.document.createElement(this.changeTypes.insertType.tag);this.env.document.createElement(this.changeTypes.deleteType.tag)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom();this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=true},disableChangeTracking:function(){this._isTracking=false},toggleChangeTracking:function(e){e=(undefined===e)?!this._isTracking:!!e;this._isTracking=e},setCurrentUser:function(e){this.currentUser=e;this._updateUserData(e)},toggleTooltips:function(e){e=(undefined===e)?!this.tooltips:!!e;this.tooltips=e;this._updateTooltipsState()},handleEvent:function(g){if(!this._isTracking){return true}if(g.type=="keypress"){var f=this.keyPress(g);if(!f){g.preventDefault()}return f}else{if(g.type=="keydown"){var f=this.keyDown(g);if(!f){g.preventDefault()}return f}}},visible:function(e){if(e.nodeType===ice.dom.TEXT_NODE){e=e.parentNode}var f=e.getBoundingClientRect();return(f.top>0&&f.left>0)},createIceNode:function(e,f){var g=this.env.document.createElement(this.changeTypes[e].tag);ice.dom.addClass(g,this._getIceNodeClass(e));if(f){g.appendChild(f)}this.addChange(this.changeTypes[e].alias,[g]);return g},insert:function(f){var e=this.getCurrentRange(),g=e?null:this.hostMethods.getHostRange(),h=this._batchChangeid?null:this.startBatchChange();if(e&&!e.collapsed){this.deleteContents(false,e,g);e=this.getCurrentRange();if(e.startContainer===e.endContainer&&this.element===e.startContainer){ice.dom.empty(this.element);e=this.selection.getRangeAt(0);e.collapse(true)}}else{if(!e&&!f){return true}}if(f&&!jQuery.isArray(f)){f=[f]}this._moveRangeToValidTrackingPos(e,g);this._insertNodes(e,g,f);this.endBatchChange(h);return true},deleteContents:function(h,f){var e=true,g=this._browser;if(f){this.selection.addRange(f)}else{f=this.getCurrentRange()}var l=this._batchChangeid?null:this.startBatchChange();if(f.collapsed===false){if(this._currentUserIceNode(f.startContainer.parentNode)){this._deleteSelection(f)}else{this._deleteSelection(f);if(this._browser.mozilla){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0);f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer))}else{f.setEndAfter(f.startContainer.parentNode)}f.collapse(false)}else{if(!this.visible(f.endContainer)){f.setEnd(f.endContainer,Math.max(0,f.endOffset-1));f.collapse(false)}}}}else{if(h){if(g.type==="mozilla"){e=this._deleteRight(f);if(!this.visible(f.endContainer)){if(f.endContainer.parentNode.nextSibling){f.setEndBefore(f.endContainer.parentNode.nextSibling)}else{f.setEndAfter(f.endContainer)}f.collapse(false)}}else{if(f.endOffset===ice.dom.getNodeCharacterLength(f.endContainer)){var i=f.startContainer.nextSibling;if(ice.dom.is(i,"."+this._getIceNodeClass("deleteType"))){while(i){if(ice.dom.is(i,"."+this._getIceNodeClass("deleteType"))){i=i.nextSibling;continue}f.setStart(i,0);f.collapse(true);break}}}e=this._deleteRight(f);if(!this.visible(f.endContainer)){if(ice.dom.is(f.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))){f.setStartAfter(f.endContainer.parentNode);f.collapse(true)}}}}else{if(g.mozilla){e=this._deleteLeft(f);if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0)}else{f.setEnd(f.startContainer.parentNode,0)}f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer));f.collapse(false)}}else{if(!this.visible(f.startContainer)){if(f.endOffset===ice.dom.getNodeCharacterLength(f.endContainer)){var k=f.startContainer.previousSibling;if(ice.dom.is(k,"."+this._getIceNodeClass("deleteType"))){while(k){if(ice.dom.is(k,"."+this._getIceNodeClass("deleteType"))){k=k.prevSibling;continue}f.setEndBefore(k.nextSibling,0);f.collapse(false);break}}}}e=this._deleteLeft(f)}}}this.selection.addRange(f);this.endBatchChange(l);return e},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[];var g=Object.keys(this._changes);for(var f in g){e.push(this._changes[g[f]].userid)}return e.sort().filter(function(l,k,h){if(k==h.indexOf(l)){return 1}return 0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,h,f){var g=this.getCleanDOM(e,h,f);return(g&&g.innerHTML)||""},getCleanDOM:function(e,l,g){var k="";var f=this;ice.dom.each(this.changeTypes,function(n,m){if(n!="deleteType"){if(m>0){k+=","}k+="."+f._getIceNodeClass(n)}});if(e){if(typeof e==="string"){e=ice.dom.create("<div>"+e+"</div>")}else{e=ice.dom.cloneNode(e,false)[0]}}else{e=ice.dom.cloneNode(this.element,false)[0]}e=g?g.call(this,e):e;var h=ice.dom.find(e,k);ice.dom.each(h,function(n,m){ice.dom.replaceWith(this,ice.dom.contents(this))});var i=ice.dom.find(e,"."+this._getIceNodeClass("deleteType"));ice.dom.remove(i);e=l?l.call(this,e):e;return e},acceptAll:function(e){if(e){return this._acceptRejectSome(e,true)}else{this.element.innerHTML=this.getCleanContent();this._changes={};this._triggerChange()}},rejectAll:function(f){if(f){return this._acceptRejectSome(f,false)}else{var g="."+this._getIceNodeClass("insertType");var e="."+this._getIceNodeClass("deleteType");ice.dom.remove(ice.dom.find(this.element,g));ice.dom.each(ice.dom.find(this.element,e),function(h,k){ice.dom.replaceWith(k,ice.dom.contents(k))});this._changes={};this._triggerChange()}},acceptChange:function(e){this.acceptRejectChange(e,true)},rejectChange:function(e){this.acceptRejectChange(e,false)},acceptRejectChange:function(h,o){var q,n,i,p,f,e,m,k=ice.dom;if(!h){var l=this.getCurrentRange();if(!l.collapsed){return}else{h=l.startContainer}}q=p="."+this._getIceNodeClass("deleteType");n=f="."+this._getIceNodeClass("insertType");i=q+","+n;e=k.getNode(h,i);var g=k.attr(e,this.attributes.changeId);m=k.find(this.element,"["+this.attributes.changeId+"="+g+"]");if(!o){p=n;f=q}if(ice.dom.is(e,f)){k.each(m,function(r,s){k.replaceWith(s,ice.dom.contents(s))})}else{if(k.is(e,p)){k.remove(m)}else{return}}if(m.length<=1){delete this._changes[g]}this._triggerChange()},isInsideChange:function(f){try{return !!this.currentChangeNode(f)}catch(g){return false}},addChangeType:function(g,f,h,i){var e={tag:f,alias:h};if(i){e.action=i}this.changeTypes[g]=e},getIceNode:function(g,f){var e="."+this._getIceNodeClass(f);return ice.dom.getNode((g&&g.$)||g,e)},_moveRangeToValidTrackingPos:function(f,i){if(!(f=i||f)){return}var h,g=null;while(h=this._getVoidElement(f&&f.endContainer)){if(i){h=this.hostMethods.makeHostElement(h)}if(h==g||(i&&h.equals(g))){break}try{f.setEndAfter(h);f.collapse()}catch(k){break}}},_getNoTrackElement:function(g){var f=this._getNoTrackSelector();var e=ice.dom.is(g,f)?g:(ice.dom.parents(g,f)[0]||null);return e},_getNoTrackSelector:function(){return this.noTrack},_getVoidElement:function(h){if(h.$){h=h.$}try{var g=this._getVoidElSelector(),f=ice.dom.is(h,g)?h:(ice.dom.parents(h,g)[0]||null);if(!f){if(3==h.nodeType&&h.nodeValue=="\u200B"){return h}}}catch(i){return null}},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")},_currentUserIceNode:function(e){return ice.dom.attr(e,this.attributes.userId)==this.currentUser.id},_getChangeTypeFromAlias:function(f){var g,e=null;for(g in this.changeTypes){if(this.changeTypes.hasOwnProperty(g)){if(this.changeTypes[g].alias==f){e=g}}}return e},_getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},getUserStyle:function(e){if(e===null||e===""||"undefined"==typeof e){return this.stylePrefix}var f=null;if(this._userStyles[e]){f=this._userStyles[e]}else{f=this.setUserStyle(e,this.getNewStyleId())}return f},setUserStyle:function(e,g){var f=this.stylePrefix+"-"+g;if(!this._styles[g]){this._styles[g]=true}return this._userStyles[e]=f},getNewStyleId:function(){var e=++this._uniqueStyleIndex;if(this._styles[e]){return this.getNewStyleId()}else{this._styles[e]=true;return e}},addChange:function(f,h){var g=this._batchChangeid||this.getNewChangeId(),e=this;if(!this._changes[g]){this._changes[g]={type:this._getChangeTypeFromAlias(f),time:(new Date()).getTime(),userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""};this._triggerChange()}ice.dom.foreach(h,function(k){e.addNodeToChange(g,h[k])});return g},addNodeToChange:function(i,h){i=this._batchChangeid||i;var k=this.getChange(i);if(!h.getAttribute(this.attributes.changeId)){h.setAttribute(this.attributes.changeId,i)}var f=h.getAttribute(this.attributes.userId);if(!f){h.setAttribute(this.attributes.userId,f=k.userid)}if(f==k.userid){h.setAttribute(this.attributes.userName,k.username)}var e=h.getAttribute(this.attributes.changeData);if(null==e){h.setAttribute(this.attributes.changeData,this._changeData||"")}if(!h.getAttribute(this.attributes.time)){h.setAttribute(this.attributes.time,k.time)}if(!ice.dom.hasClass(h,this._getIceNodeClass(k.type))){ice.dom.addClass(h,this._getIceNodeClass(k.type))}var g=this.getUserStyle(k.userid);if(!ice.dom.hasClass(h,g)){ice.dom.addClass(h,g)}this._updateNodeTooltip(h)},getChange:function(e){return this._changes[e]||null},getNewChangeId:function(){var e=++this._uniqueIDIndex;if(this._changes[e]){e=this.getNewChangeId()}return e},startBatchChange:function(){this._batchChangeid=this.getNewChangeId();return this._batchChangeid},endBatchChange:function(e){if(e!==this._batchChangeid){return}this._batchChangeid=null;this._triggerChangeText()},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(f){return null}},_insertNodes:function(e,r,s){var p=r||e,w=p.startContainer,m=(w&&w.$)||w,x=r?this.hostMethods.makeHostElement:d;if(!ice.dom.isBlockElement(m)&&!ice.dom.canContainTextElement(ice.dom.getBlockParent(m,this.element))&&m.previousSibling){p.setStart(x(m.previousSibling),0);m=r?r.startContainer&&r.startContainer.$:p.startContainer}var q=this.getIceNode(m,"insertType"),k=this._currentUserIceNode(q);if(k){var n=s&&s[0];if(n){p.insertNode(x(n));var o=n.parentNode,y=n.nextSibling;for(var u=1;u<s.length;++u){if(y){o.insertBefore(s[u],y)}else{o.appendChild(s[u])}}}}else{var t=this.createIceNode("insertType");if(q){var g=q.childNodes.length;q.normalize();if(g!=q.childNodes.length){if(r){r=p=this.hostMethods.getHostRange()}else{p=this.getCurrentRange()}}if(q){var l=(r&&r.endContainer.$)||p.endContainer;if((l.nodeType==3&&p.endOffset<p.endContainer.length)||(l!=q.lastChild)){q=this._splitNode(q,p.endContainer,p.endOffset)}}}if(q){p.setStartAfter(x(q));p.collapse(true)}p.insertNode(x(t));var v=(s&&s.length)||0;if(v){for(var u=0;u<v;++u){t.appendChild(s[u])}p.setStartAfter(x(t.lastChild))}else{var h=this.element.ownerDocument.createTextNode("\uFEFF");t.appendChild(h);h=x(h);p.setStartAndEnd(h,0,h,1)}if(r){this.hostMethods.setHostRange(r)}else{this.selection.addRange(p)}}},_handleVoidEl:function(f,e){var g=f&&this._getVoidElement(f);if(g&&!this.getIceNode(g,"deleteType")){e.collapse(true);return true}return false},_deleteSelection:function(n){var o=new ice.Bookmark(this.env,n),e=ice.dom.getElementsBetween(o.start,o.end),q=ice.dom.parents(n.startContainer,this.blockEls.join(", "))[0],p=ice.dom.parents(n.endContainer,this.blockEls.join(", "))[0],r=new Array();for(var m=0;m<e.length;m++){var h=e[m];if(ice.dom.isBlockElement(h)){r.push(h);if(!ice.dom.canContainTextElement(h)){for(var l=0;l<h.childNodes.length;l++){e.push(h.childNodes[l])}continue}}if(h.nodeType===ice.dom.TEXT_NODE&&ice.dom.getNodeTextContent(h).length===0){continue}if(!this._getVoidElement(h)){if(h.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(h)){continue}if(ice.dom.isStubElement(h)){this._addNodeTracking(h,false,true);continue}if(ice.dom.hasNoTextOrStubContent(h)){ice.dom.remove(h)}for(j=0;j<h.childNodes.length;j++){var g=h.childNodes[j];e.push(g)}continue}var f=ice.dom.getBlockParent(h);this._addNodeTracking(h,false,true,true);if(ice.dom.hasNoTextOrStubContent(f)){ice.dom.remove(f)}}}if(this.mergeBlocks&&q!==p){while(r.length){ice.dom.mergeContainers(r.shift(),q)}ice.dom.removeBRFromChild(p);ice.dom.removeBRFromChild(q);ice.dom.mergeContainers(p,q)}o.selectBookmark();n.collapse(true)},_deleteRight:function(s){var g=ice.dom.isBlockElement(s.startContainer)&&s.startContainer||ice.dom.getBlockParent(s.startContainer,this.element)||null,t=g?(ice.dom.hasNoTextOrStubContent(g)):false,q=g&&ice.dom.getNextContentNode(g,this.element),u=q?(ice.dom.hasNoTextOrStubContent(q)):false,n=s.endContainer,m=s.endOffset,h=s.commonAncestorContainer,o,y;if(t){return false}if(h.nodeType!==ice.dom.TEXT_NODE){if(m===0&&ice.dom.isBlockElement(h)&&(!ice.dom.canContainTextElement(h))){var w=h.firstElementChild;if(w){s.setStart(w,0);s.collapse();return this._deleteRight(s)}}if(h.childNodes.length>m){var k=document.createTextNode(" ");h.insertBefore(k,h.childNodes[m]);s.setStart(k,1);s.collapse(true);y=this._deleteRight(s);ice.dom.remove(k);return y}else{o=ice.dom.getNextContentNode(h,this.element);s.setEnd(o,0);s.collapse();return this._deleteRight(s)}}s.moveEnd(ice.dom.CHARACTER_UNIT,1);s.moveEnd(ice.dom.CHARACTER_UNIT,-1);if(m===n.data.length&&(!ice.dom.hasNoTextOrStubContent(n))){o=ice.dom.getNextNode(n,this.element);if(!o){s.selectNodeContents(n);s.collapse();return false}if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(o)){o=ice.dom.getNextNode(o,this.element)}if(o.nodeType===ice.dom.TEXT_NODE){o=o.parentNode}if(!o.isContentEditable){y=this._addNodeTracking(o,false,false);var l=document.createTextNode("");o.parentNode.insertBefore(l,o.nextSibling);s.selectNode(l);s.collapse(true);return y}if(this._handleVoidEl(o,s)){return true}if(ice.dom.isChildOf(o,g)&&ice.dom.isStubElement(o)){return this._addNodeTracking(o,s,false)}}if(this._handleVoidEl(o,s)){return true}if(this._getNoTrackElement(s.endContainer.parentElement)){s.deleteContents();return false}if(ice.dom.isOnBlockBoundary(s.startContainer,s.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(o,this.element),this.blockEl)){if(q!==ice.dom.getBlockParent(s.endContainer,this.element)){s.setEnd(q,0)}var r=ice.dom.getElementsBetween(s.startContainer,s.endContainer);for(var v=0;v<r.length;v++){ice.dom.remove(r[v])}var x=s.startContainer;var z=s.endContainer;ice.dom.remove(ice.dom.find(x,"br"));ice.dom.remove(ice.dom.find(z,"br"));return ice.dom.mergeBlockWithSibling(s,ice.dom.getBlockParent(s.endContainer,this.element)||g)}else{if(u){ice.dom.remove(q);s.collapse(true);return true}s.setStart(q,0);s.collapse(true);return true}}var e=s.endContainer;var p=e.splitText(s.endOffset);var f=p.splitText(1);return this._addNodeTracking(p,s,false)},_deleteLeft:function(s){var h=ice.dom.isBlockElement(s.startContainer)&&s.startContainer||ice.dom.getBlockParent(s.startContainer,this.element)||null,t=h?ice.dom.hasNoTextOrStubContent(h):false,o=h&&ice.dom.getPrevContentNode(h,this.element),w=o?ice.dom.hasNoTextOrStubContent(o):false,n=s.startContainer,m=s.startOffset,k=s.commonAncestorContainer,g,v;if(t){return false}if(m===0||k.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(k)&&(!ice.dom.canContainTextElement(k))){if(m===0){var x=k.firstElementChild;if(x){s.setStart(x,0);s.collapse();return this._deleteLeft(s)}}else{var q=k.lastElementChild;if(q){g=s.getLastSelectableChild(q);if(g){s.setStart(g,g.data.length);s.collapse();return this._deleteLeft(s)}}}}if(m===0){v=ice.dom.getPrevContentNode(n,this.element)}else{v=k.childNodes[m-1]}if(!v){return false}if(ice.dom.is(v,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&v.childNodes.length>0&&v.lastChild){v=v.lastChild}if(v.nodeType===ice.dom.TEXT_NODE){v=v.parentNode}if(!v.isContentEditable){var z=this._addNodeTracking(v,false,true);var l=document.createTextNode("");v.parentNode.insertBefore(l,v);s.selectNode(l);s.collapse(true);return z}if(this._handleVoidEl(v,s)){return true}if(ice.dom.isStubElement(v)&&ice.dom.isChildOf(v,h)||!v.isContentEditable){return this._addNodeTracking(v,s,true)}if(ice.dom.isStubElement(v)){ice.dom.remove(v);s.collapse(true);return false}if(v!==h&&!ice.dom.isChildOf(v,h)){if(!ice.dom.canContainTextElement(v)){v=v.lastElementChild}if(v.lastChild&&v.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(v.lastChild)&&v.lastChild.tagName!=="BR"){s.setStartAfter(v.lastChild);s.collapse(true);return true}g=s.getLastSelectableChild(v);if(g&&!ice.dom.isOnBlockBoundary(s.startContainer,g,this.element)){s.selectNodeContents(g);s.collapse();return true}}}if(m===1&&!ice.dom.isBlockElement(k)&&s.startContainer.childNodes.length>1&&s.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&s.startContainer.childNodes[0].data.length===0){s.setStart(s.startContainer,0);return this._deleteLeft(s)}s.moveStart(ice.dom.CHARACTER_UNIT,-1);s.moveStart(ice.dom.CHARACTER_UNIT,1);if(this._getNoTrackElement(s.startContainer.parentElement)){s.deleteContents();return false}if(ice.dom.isOnBlockBoundary(s.startContainer,s.endContainer,this.element)){if(w){ice.dom.remove(o);s.collapse();return true}if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(v,this.element),this.blockEl)){if(o!==ice.dom.getBlockParent(s.startContainer,this.element)){s.setStart(o,o.childNodes.length)}var r=ice.dom.getElementsBetween(s.startContainer,s.endContainer);for(var u=0;u<r.length;u++){ice.dom.remove(r[u])}var y=s.startContainer;var A=s.endContainer;ice.dom.remove(ice.dom.find(y,"br"));ice.dom.remove(ice.dom.find(A,"br"));return ice.dom.mergeBlockWithSibling(s,ice.dom.getBlockParent(s.endContainer,this.element)||h)}if(o&&o.lastChild&&ice.dom.isStubElement(o.lastChild)){s.setStartAfter(o.lastChild);s.collapse(true);return true}g=s.getLastSelectableChild(o);if(g){s.setStart(g,g.data.length);s.collapse(true)}else{if(o){s.setStart(o,o.childNodes.length);s.collapse(true)}}return true}var e=s.startContainer;var p=e.splitText(s.startOffset-1);var f=p.splitText(1);return this._addNodeTracking(p,s,true)},_addNodeTracking:function(k,l,m){var n=this.getIceNode(k,"insertType");if(n&&this._currentUserIceNode(n)){if(l&&m){l.selectNode(k)}k.parentNode.removeChild(k);var e=ice.dom.cloneNode(n);ice.dom.remove(ice.dom.find(e,".iceBookmark"));if(n!==null&&(ice.dom.hasNoTextOrStubContent(e[0]))){var o=this.env.document.createTextNode("");ice.dom.insertBefore(n,o);if(l){l.setStart(o,0);l.collapse(true)}ice.dom.replaceWith(n,ice.dom.contents(n))}return true}else{if(l&&this.getIceNode(k,"deleteType")){this._normalizeNode(k);var s=false;if(m){var f=ice.dom.getPrevContentNode(k,this.element);while(!s){q=this.getIceNode(f,"deleteType");if(!q){s=true}else{f=ice.dom.getPrevContentNode(f,this.element)}}if(f){var p=l.getLastSelectableChild(f);if(p){f=p}l.setStart(f,ice.dom.getNodeCharacterLength(f));l.collapse(true)}return true}else{var i=ice.dom.getNextContentNode(k,this.element);while(!s){q=this.getIceNode(i,"deleteType");if(!q){s=true}else{i=ice.dom.getNextContentNode(i,this.element)}}if(i){l.selectNodeContents(i);l.collapse(true)}return true}}}if(k.previousSibling&&k.previousSibling.nodeType===ice.dom.TEXT_NODE&&k.previousSibling.length===0){k.parentNode.removeChild(k.previousSibling)}if(k.nextSibling&&k.nextSibling.nodeType===ice.dom.TEXT_NODE&&k.nextSibling.length===0){k.parentNode.removeChild(k.nextSibling)}var g=this.getIceNode(k.previousSibling,"deleteType");var r=this.getIceNode(k.nextSibling,"deleteType");var q;if(g&&this._currentUserIceNode(g)){q=g;q.appendChild(k);if(r&&this._currentUserIceNode(r)){var h=ice.dom.extractContent(r);ice.dom.append(q,h);r.parentNode.removeChild(r)}}else{if(r&&this._currentUserIceNode(r)){q=r;q.insertBefore(k,q.firstChild)}else{q=this.createIceNode("deleteType");k.parentNode.insertBefore(q,k);q.appendChild(k)}}if(l){if(ice.dom.isStubElement(k)){l.selectNode(k)}else{l.selectNodeContents(k)}if(m){l.collapse(true)}else{l.collapse()}this._normalizeNode(k)}return true},_handleAncillaryKey:function(m){var l=m.keyCode?m.keyCode:m.which,i=this._browser,h=true,k=m.shiftKey,g=this,f=g.getCurrentRange();switch(l){case ice.dom.DOM_VK_DELETE:h=this.deleteContents();break;case 46:h=this.deleteContents(true);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:if(i.type==="mozilla"){if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.previousSibling){f.setEnd(f.startContainer.parentNode.previousSibling,0);f.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(f.endContainer));f.collapse(false)}else{f.setEnd(f.startContainer.parentNode.nextSibling,0);f.collapse(false)}}}h=false;break;case ice.dom.DOM_VK_RIGHT:if(i.type==="mozilla"){if(!this.visible(f.startContainer)){if(f.startContainer.parentNode.nextSibling){f.setStart(f.startContainer.parentNode.nextSibling,0);f.collapse(true)}}}h=false;break;default:h=false;break}if(h===true){ice.dom.preventDefault(m);return false}return true},keyDown:function(g){var f=false;if(this._handleSpecialKey(g)===false){if(ice.dom.isBrowser("msie")!==true){this._preventKeyPress=true}return false}switch(g.keyCode){case 27:break;default:if(!this._browser.firefox){f=!(this._handleAncillaryKey(g))}break}if(f){ice.dom.preventDefault(g);return false}return true},keyPress:function(i){if(this._preventKeyPress===true){this._preventKeyPress=false;return}var k=null;if(i.which==null){k=String.fromCharCode(i.keyCode)}else{if(i.which>0){k=String.fromCharCode(i.which)}}if(i.ctrlKey||i.metaKey){return true}var f=this.getCurrentRange(),h=f&&ice.dom.parents(f.startContainer,"br")[0]||null;if(h){f.moveToNextEl(h);h.parentNode.removeChild(h)}if(k!==null&&i.ctrlKey!==true&&i.metaKey!==true){var g=i.keyCode?i.keyCode:i.which;switch(g){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(i);case ice.dom.DOM_VK_ENTER:return this._handleEnter();default:this._moveRangeToValidTrackingPos(f);return this.insert()}}return this._handleAncillaryKey(i)},_handleEnter:function(){var e=this.getCurrentRange();if(e&&!e.collapsed){this.deleteContents()}return true},_handleSpecialKey:function(l){var k=l.which;if(k===null){k=l.keyCode}var h=false;switch(k){case 65:if(!this._handleSelectAll){return true}if(l.ctrlKey===true||l.metaKey===true){h=true;var g=this.getCurrentRange();if(ice.dom.isBrowser("msie")===true){var m=this.env.document.createTextNode("");var f=this.env.document.createTextNode("");if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,m)}else{this.element.appendChild(m)}this.element.appendChild(f);g.setStart(m,0);g.setEnd(f,0)}else{g.setStart(g.getFirstSelectableChild(this.element),0);var i=g.getLastSelectableChild(this.element);g.setEnd(i,i.length)}this.selection.addRange(g)}break;default:break}if(h===true){ice.dom.preventDefault(l);return false}return true},getContentElement:function(){return this.element},getIceNodes:function(){var f=[];var e=this;ice.dom.each(this.changeTypes,function(h,g){f.push("."+e._getIceNodeClass(h))});f=f.join(",");return jQuery(this.element).find(f)},currentChangeNode:function(g){var e="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!g){var f=this.getCurrentRange();if(!f||!f.collapsed){return false}else{g=f.startContainer}}return ice.dom.getNode(g,e)},setShowChanges:function(e){e=!!e;this._isVisible=e;var f=jQuery(this.element);f.toggleClass("ICE-Tracking",e);this._showTitles(e);this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var e in this._changes){var f=this._changes[e];if(f&&f.type){return true}}return false},countChanges:function(e){var f=this._filterChanges(e);return f.count},setChangeData:function(e){if(null==e||(typeof e=="undefined")){e=""}this._changeData=String(e)},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},toString:function(){return"ICE "+((this.element&&this.element.id)||"(no element id)")},_splitNode:function(i,m,e){var h=i.parentNode,f=rangy.dom.getNodeIndex(i),l=m.ownerDocument,g=l.createRange(),k;g.setStart(h,f);g.setEnd(m,e);k=g.extractContents();h.insertBefore(k,i);return i.previousSibling},_triggerChange:function(){this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(e){if(this.tooltips&&this._isTracking&&this._isVisible){this._addTooltip(e)}},_acceptRejectSome:function(h,e){var k=(function(f,m){this.acceptRejectChange(m,e)}).bind(this);var i=this._filterChanges(h);for(var l in i.changes){var g=ice.dom.find(this.element,"["+this.attributes.changeId+"="+l+"]");g.each(k)}if(i.count){this._triggerChange()}},_filterChanges:function(n){var h=0,k={};var f=n&&n.filter;var g=n&&n.exclude?jQuery.map(n.exclude,function(o){return String(o)}):null;var e=n&&n.include?jQuery.map(n.include,function(o){return String(o)}):null;for(var m in this._changes){var i=this._changes[m];if(i&&i.type){var l=(f&&!f({userid:i.userid,time:i.time,data:i.data}))||(g&&g.indexOf(i.userid)>=0)||(e&&e.indexOf(i.userid)<0);if(!l){++h;k[m]=i}}}return{count:h,changes:k}},_loadFromDom:function(){this._changes={};this._uniqueStyleIndex=0;var k=this.currentUser&&this.currentUser.id;var i=(this.currentUser&&this.currentUser.name)||"";var h=(new Date()).getTime();var m=[];for(var e in this.changeTypes){m.push(this._getIceNodeClass(e))}var g=this.getIceNodes();function l(p,n){var t=0;var w="";var f=n.className.split(" ");for(var p=0;p<f.length;p++){var v=new RegExp(this.stylePrefix+"-(\\d+)").exec(f[p]);if(v){t=v[1]}var x=new RegExp("("+m.join("|")+")").exec(f[p]);if(x){w=this._getChangeTypeFromAlias(x[1])}}var q=ice.dom.attr(n,this.attributes.userId);var u;if(k&&(q==k)){u=i;n.setAttribute(this.attributes.userName,i)}else{u=n.getAttribute(this.attributes.userName)}this.setUserStyle(q,Number(t));var y=parseInt(ice.dom.attr(n,this.attributes.changeId)||"");if(isNaN(y)){y=this.getNewChangeId();n.setAttribute(this.attributes.changeId,y)}var o=parseInt(n.getAttribute(this.attributes.time)||"");if(isNaN(o)){o=h}var r=ice.dom.attr(n,this.attributes.changeData)||"";var s={type:w,userid:String(q),username:u,time:o,data:r};this._changes[y]=s;this._updateNodeTooltip(n)}g.each(l.bind(this));this._triggerChange()},_updateUserData:function(f){if(f){for(var g in this._changes){var h=this._changes[g];if(h.userid==f.id){h.username=f.name}}}var e=this.getIceNodes();e.each((function(l,m){var k=(!f)||(f.id==m.getAttribute(this.attributes.userId));if(f&&k){m.setAttribute(this.userNameAttribute,f.name)}}).bind(this))},_showTitles:function(f){var e=this.getIceNodes();if(f){jQuery(e).each((function(g,h){this._updateNodeTooltip(h)}).bind(this))}else{jQuery(e).removeAttr("title")}},_updateTooltipsState:function(){if(this.tooltips&&this._isTracking&&this._isVisible){if(!this._showingTips){this._showingTips=true;var f=this.getIceNodes(),e=this;f.each(function(g,h){e._addTooltip(h)})}}else{if(this._showingTips){this._showingTips=false;var f=this.getIceNodes();f.each(function(g,h){jQuery(h).unbind("mouseover").unbind("mouseout")})}}},_addTooltip:function(e){jQuery(e).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(h){var g=h.currentTarget,f=jQuery(g),e=this;if(!f.data("_tooltip_t")){var i=setTimeout(function(){var l=f.attr(e.attributes.changeId),k=e.getChange(l);if(k){f.removeData("_tooltip_t");e.hostMethods.showTooltip(g,jQuery.extend({},k))}},this.tooltipsDelay);f.data("_tooltip_t",i)}},_tooltipMouseOut:function(g){var f=g.currentTarget,e=jQuery(f),h=e.data("_tooltip_t");e.removeData("_tooltip_t");if(h){clearTimeout(h)}else{this.hostMethods.hideTooltip(f)}},_normalizeNode:function(e){if(!e){return}if(typeof e.normalize=="function"){return e.normalize()}return this._myNormalizeNode(e)},_myNormalizeNode:function(h){if(!h){return}var e=1;var f=3;var k=h.firstChild;while(k){if(k.nodeType==e){this._myNormalizeNode(k)}else{if(k.nodeType==f){var g;while((g=k.nextSibling)&&g.nodeType==f){var i=g.nodeValue;if(i!=null&&i.length){k.nodeValue=k.nodeValue+i}h.removeChild(g)}}}k=k.nextSibling}}};a.ice=this.ice||{};a.ice.InlineChangeEditor=b}).call(this);(function(){var b=this,c={},a=null;c.DOM_VK_DELETE=8;c.DOM_VK_LEFT=37;c.DOM_VK_UP=38;c.DOM_VK_RIGHT=39;c.DOM_VK_DOWN=40;c.DOM_VK_ENTER=13;c.ELEMENT_NODE=1;c.ATTRIBUTE_NODE=2;c.TEXT_NODE=3;c.CDATA_SECTION_NODE=4;c.ENTITY_REFERENCE_NODE=5;c.ENTITY_NODE=6;c.PROCESSING_INSTRUCTION_NODE=7;c.COMMENT_NODE=8;c.DOCUMENT_NODE=9;c.DOCUMENT_TYPE_NODE=10;c.DOCUMENT_FRAGMENT_NODE=11;c.NOTATION_NODE=12;c.CHARACTER_UNIT="character";c.WORD_UNIT="word";c.BREAK_ELEMENT="br";c.CONTENT_STUB_ELEMENTS=["img","hr","iframe","param","link","meta","input","frame","col","base","area"];c.BLOCK_ELEMENTS=["body","p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"];c.TEXT_CONTAINER_ELEMENTS=["body","p","div","pre","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"];c.STUB_ELEMENTS=c.CONTENT_STUB_ELEMENTS.slice();c.STUB_ELEMENTS.push(c.BREAK_ELEMENT);c.getKeyChar=function(d){return String.fromCharCode(d.which)};c.getClass=function(f,e,d){if(!e){e=document.body}f="."+f.split(" ").join(".");if(d){f=d+f}return jQuery.makeArray(jQuery(e).find(f))};c.getId=function(e,d){if(!d){d=document}element=d.getElementById(e);return element};c.getTag=function(d,e){if(!e){e=document}return jQuery.makeArray(jQuery(e).find(d))};c.getElementWidth=function(d){return d.offsetWidth};c.getElementHeight=function(d){return d.offsetHeight};c.getElementDimensions=function(e){var d={width:c.getElementWidth(e),height:c.getElementHeight(e)};return d};c.trim=function(d){return jQuery.trim(d)};c.empty=function(d){if(d){return jQuery(d).empty()}};c.remove=function(d){if(d){return jQuery(d).remove()}};c.prepend=function(d,e){jQuery(d).prepend(e)};c.append=function(d,e){jQuery(d).append(e)};c.insertBefore=function(e,d){jQuery(e).before(d)};c.insertAfter=function(e,d){jQuery(e).after(d)};c.getHtml=function(d){return jQuery(d).html()};c.setHtml=function(d,e){if(d){jQuery(d).html(e)}};c.removeWhitespace=function(d){jQuery(d).contents().filter(function(){if(this.nodeType!=ice.dom.TEXT_NODE&&this.nodeName=="UL"||this.nodeName=="OL"){c.removeWhitespace(this);return false}else{if(this.nodeType!=ice.dom.TEXT_NODE){return false}else{return !/\S/.test(this.nodeValue)}}}).remove()};c.contents=function(d){return jQuery.makeArray(jQuery(d).contents())};c.extractContent=function(d){var f=document.createDocumentFragment(),e;while((e=d.firstChild)){f.appendChild(e)}return f};c.getNode=function(e,d){if(!e){return null}e=e.$||e;return(e.nodeType!=3&&c.is(e,d))?e:c.parents(e,d)[0]||null},c.getParents=function(l,g,k){var f=jQuery(l).parents(g);var h=f.length;var d=[];for(var e=0;e<h;e++){if(f[e]===k){break}d.push(f[e])}return d};c.hasBlockChildren=function(e){var f=e.childNodes.length;for(var d=0;d<f;d++){if(e.childNodes[d].nodeType===c.ELEMENT_NODE){if(c.isBlockElement(e.childNodes[d])===true){return true}}}return false};c.removeTag=function(e,d){jQuery(e).find(d).replaceWith(function(){return jQuery(this).contents()});return e};c.stripEnclosingTags=function(d,f){var e=jQuery(d);e.find("*").not(f).replaceWith(function(){var g=jQuery();var i;try{i=jQuery(this);g=i.contents()}catch(h){}if(g.length===0){i.remove()}return g});return e[0]};c.getSiblings=function(g,f,h,e){if(h===true){if(f==="prev"){return jQuery(g).prevAll()}else{return jQuery(g).nextAll()}}else{var d=[];if(f==="prev"){while(g.previousSibling){g=g.previousSibling;if(g===e){break}d.push(g)}}else{while(g.nextSibling){g=g.nextSibling;if(g===e){break}d.push(g)}}return d}};c.getNodeTextContent=function(d){return jQuery(d).text()};c.getNodeStubContent=function(d){return jQuery(d).find(c.CONTENT_STUB_ELEMENTS.join(", "))};c.hasNoTextOrStubContent=function(d){if(c.getNodeTextContent(d).length>0){return false}if(jQuery(d).find(c.CONTENT_STUB_ELEMENTS.join(", ")).length>0){return false}return true};c.getNodeCharacterLength=function(d){return c.getNodeTextContent(d).length+jQuery(d).find(c.STUB_ELEMENTS.join(", ")).length};c.setNodeTextContent=function(e,d){return jQuery(e).text(d)};c.getTagName=function(d){return d.tagName&&d.tagName.toLowerCase()||null};c.getIframeDocument=function(d){var e=null;if(d.contentDocument){e=d.contentDocument}else{if(d.contentWindow){e=d.contentWindow.document}else{if(d.document){e=d.document}}}return e};c.isBlockElement=function(d){return c.BLOCK_ELEMENTS.lastIndexOf(d.nodeName.toLowerCase())!=-1};c.isStubElement=function(d){return c.STUB_ELEMENTS.lastIndexOf(d.nodeName.toLowerCase())!=-1};c.removeBRFromChild=function(d){if(d&&d.hasChildNodes()){for(var e=0;e<d.childNodes.length;e++){var f=d.childNodes[e];if(f&&(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(f))){f.parentNode.removeChild(f)}}}};c.isChildOf=function(f,d){try{while(f&&f.parentNode){if(f.parentNode===d){return true}f=f.parentNode}}catch(g){}return false};c.isChildOfTagName=function(f,d){try{while(f&&f.parentNode){if(f.parentNode&&f.parentNode.tagName&&f.parentNode.tagName.toLowerCase()===d){return f.parentNode}f=f.parentNode}}catch(g){}return false};c.isChildOfTagNames=function(f,h){try{while(f&&f.parentNode){if(f.parentNode&&f.parentNode.tagName){tagName=f.parentNode.tagName.toLowerCase();for(var d=0;d<h.length;d++){if(tagName===h[d]){return f.parentNode}}}f=f.parentNode}}catch(g){}return null};c.isChildOfClassName=function(f,d){try{while(f&&f.parentNode){if(jQuery(f.parentNode).hasClass(d)){return f.parentNode}f=f.parentNode}}catch(g){}return null};c.cloneNode=function(d,e){if(e===undefined){e=true}return jQuery(d).clone(e)};c.bind=function(d,e,f){return jQuery(d).bind(e,f)};c.unbind=function(d,e,f){return jQuery(d).unbind(e,f)};c.attr=function(e,d,f){if(f){return jQuery(e).attr(d,f)}else{return jQuery(e).attr(d)}};c.replaceWith=function(e,d){return jQuery(e).replaceWith(d)};c.removeAttr=function(e,d){jQuery(e).removeAttr(d)};c.getElementsBetween=function(o,k){var d=[];if(o===k){return d}if(c.isChildOf(k,o)===true){var l=o.childNodes.length;for(var g=0;g<l;g++){if(o.childNodes[g]===k){break}else{if(c.isChildOf(k,o.childNodes[g])===true){return c.arrayMerge(d,c.getElementsBetween(o.childNodes[g],k))}else{d.push(o.childNodes[g])}}}return d}var f=o.nextSibling;while(f){if(c.isChildOf(k,f)===true){d=c.arrayMerge(d,c.getElementsBetween(f,k));return d}else{if(f===k){return d}else{d.push(f);f=f.nextSibling}}}var q=c.getParents(o);var m=c.getParents(k);var p=c.arrayDiff(q,m,true);var n=p.length;for(var e=0;e<(n-1);e++){d=c.arrayMerge(d,c.getSiblings(p[e],"next"))}var h=p[(p.length-1)];d=c.arrayMerge(d,c.getElementsBetween(h,k));return d};c.getCommonAncestor=function(e,d){var f=e;while(f){if(c.isChildOf(d,f)===true){return f}f=f.parentNode}return null};c.getNextNode=function(e,d){if(e){while(e.parentNode){if(e===d){return null}if(e.nextSibling){if(e.nextSibling.nodeType===c.TEXT_NODE&&e.nextSibling.length===0){e=e.nextSibling;continue}return c.getFirstChild(e.nextSibling)}e=e.parentNode}}return null};c.getNextContentNode=function(e,d){if(e){while(e.parentNode){if(e===d){return null}if(e.nextSibling&&c.canContainTextElement(c.getBlockParent(e))){if(e.nextSibling.nodeType===c.TEXT_NODE&&e.nextSibling.length===0){e=e.nextSibling;continue}return e.nextSibling}else{if(e.nextElementSibling){return e.nextElementSibling}}e=e.parentNode}}return null};c.getPrevNode=function(e,d){if(e){while(e.parentNode){if(e===d){return null}if(e.previousSibling){if(e.previousSibling.nodeType===c.TEXT_NODE&&e.previousSibling.length===0){e=e.previousSibling;continue}return c.getLastChild(e.previousSibling)}e=e.parentNode}}return null};c.getPrevContentNode=function(e,d){if(e){while(e.parentNode){if(e===d){return null}if(e.previousSibling&&c.canContainTextElement(c.getBlockParent(e))){if(e.previousSibling.nodeType===c.TEXT_NODE&&e.previousSibling.length===0){e=e.previousSibling;continue}return e.previousSibling}else{if(e.previousElementSibling){return e.previousElementSibling}}e=e.parentNode}}return null};c.canContainTextElement=function(d){if(d&&d.nodeName){return c.TEXT_CONTAINER_ELEMENTS.lastIndexOf(d.nodeName.toLowerCase())!=-1}else{return false}};c.getFirstChild=function(d){if(d.firstChild){if(d.firstChild.nodeType===c.ELEMENT_NODE){return c.getFirstChild(d.firstChild)}else{return d.firstChild}}return d};c.getLastChild=function(d){if(d.lastChild){if(d.lastChild.nodeType===c.ELEMENT_NODE){return c.getLastChild(d.lastChild)}else{return d.lastChild}}return d};c.removeEmptyNodes=function(f,g){var d=jQuery(f).find(":empty");var e=d.length;while(e>0){e--;if(c.isStubElement(d[e])===false){if(!g||g.call(this,d[e])!==false){c.remove(d[e])}}}};c.create=function(d){return jQuery(d)[0]};c.find=function(d,e){return jQuery(d).find(e)};c.children=function(d,e){return jQuery(d).children(e)};c.parent=function(e,d){return jQuery(e).parent(d)[0]};c.parents=function(e,d){return jQuery(e).parents(d)};c.is=function(d,e){return jQuery(d).is(e)};c.extend=function(d,g,f,e){return jQuery.extend.apply(this,arguments)};c.walk=function(e,g,d){if(!e){return}if(!d){d=0}var f=g.call(this,e,d);if(f===false){return}if(e.childNodes&&e.childNodes.length>0){c.walk(e.firstChild,g,(d+1))}else{if(e.nextSibling){c.walk(e.nextSibling,g,d)}else{if(e.parentNode&&e.parentNode.nextSibling){c.walk(e.parentNode.nextSibling,g,(d-1))}}}};c.revWalk=function(d,f){if(!d){return}var e=f.call(this,d);if(e===false){return}if(d.childNodes&&d.childNodes.length>0){c.walk(d.lastChild,f)}else{if(d.previousSibling){c.walk(d.previousSibling,f)}else{if(d.parentNode&&d.parentNode.previousSibling){c.walk(d.parentNode.previousSibling,f)}}}};c.setStyle=function(d,f,e){if(d){jQuery(d).css(f,e)}};c.getStyle=function(d,e){return jQuery(d).css(e)};c.hasClass=function(d,e){return jQuery(d).hasClass(e)};c.addClass=function(d,e){jQuery(d).addClass(e)};c.removeClass=function(d,e){jQuery(d).removeClass(e)};c.preventDefault=function(d){d.preventDefault();c.stopPropagation(d)};c.stopPropagation=function(d){d.stopPropagation()};c.noInclusionInherits=function(f,e){if(e instanceof String||typeof e==="string"){e=window[e]}if(f instanceof String||typeof f==="string"){f=window[f]}var d=function(){};if(c.isset(e)===true){for(value in e.prototype){if(f.prototype[value]){d.prototype[value]=e.prototype[value];continue}f.prototype[value]=e.prototype[value]}}if(f.prototype){d.prototype.constructor=e;f.prototype["super"]=new d()}};c.each=function(d,e){jQuery.each(d,function(f,g){e.call(this,f,g)})};c.foreach=function(h,e){if(h instanceof Array||h instanceof NodeList||typeof h.length!="undefined"&&typeof h.item!="undefined"){var d=h.length;for(var g=0;g<d;g++){var f=e.call(this,g,h[g]);if(f===false){break}}}else{for(var k in h){if(h.hasOwnProperty(k)===true){var f=e.call(this,k);if(f===false){break}}}}};c.isBlank=function(d){if(!d||/^\s*$/.test(d)){return true}return false};c.isFn=function(d){if(typeof d==="function"){return true}return false};c.isObj=function(d){if(d!==null&&typeof d==="object"){return true}return false};c.isset=function(d){if(typeof d!=="undefined"&&d!==null){return true}return false};c.isArray=function(d){return jQuery.isArray(d)};c.isNumeric=function(e){var d=e.match(/^\d+$/);if(d!==null){return true}return false};c.getUniqueId=function(){var e=(new Date()).getTime();var d=Math.ceil(Math.random()*1000000);var f=e+""+d;return f.substr(5,18).replace(/,/,"")};c.inArray=function(g,e){var f=e.length;for(var d=0;d<f;d++){if(g===e[d]){return true}}return false};c.arrayDiff=function(h,g,f){var k=h.length;var e=[];for(var d=0;d<k;d++){if(c.inArray(h[d],g)===false){e.push(h[d])}}if(f!==true){k=g.length;for(var d=0;d<k;d++){if(c.inArray(g[d],h)===false){e.push(g[d])}}}return e};c.arrayMerge=function(f,e){var g=e.length;for(var d=0;d<g;d++){f.push(e[d])}return f};c.stripTags=function(f,i){if(typeof i==="string"){var h=jQuery("<div>"+f+"</div>");h.find("*").not(i).remove();return h.html()}else{var d;var e=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim);var g=f;while((d=e.exec(f))!=null){if(c.isset(i)===false||c.inArray(d[1],i)!==true){g=g.replace(d[0],"")}}return g}};c.browser=function(){if(a){return jQuery.extend({},a)}a=(function(){function e(h){h=h.toLowerCase();var g=/(chrome)[ \/]([\w.]+)/.exec(h)||/(webkit)[ \/]([\w.]+)/.exec(h)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(h)||/(msie) ([\w.]+)/.exec(h)||h.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(h)||[];return{browser:g[1]||"",version:g[2]||"0"}}var d=e(navigator.userAgent);var f={type:"unknown",version:0};if(d.browser){f[d.browser]=true;f.version=d.version||0;f.type=d.browser}if(f.chrome){f.webkit=true}else{if(f.webkit){f.safari=true}}if(f.webkit){f.type="webkit"}f.firefox=(/Firefox/.test(navigator.userAgent)==true);return f})();return jQuery.extend({},a)};c.getBrowserType=function(){if(this._browserType===null){var f=["msie","firefox","chrome","safari"];var e=f.length;for(var d=0;d<e;d++){var g=new RegExp(f[d],"i");if(g.test(navigator.userAgent)===true){this._browserType=f[d];return this._browserType}}this._browserType="other"}return this._browserType};c.getWebkitType=function(){if(c.browser().type!=="webkit"){console.log("Not a webkit!");return false}var d=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;if(d){return"safari"}return"chrome"};c.isBrowser=function(d){return(c.browser().type===d)};c.getBlockParent=function(e,d){if(c.isBlockElement(e)===true){return e}if(e){while(e.parentNode){e=e.parentNode;if(c.isBlockElement(e)===true){return e}if(e===d){return null}}}return null};c.findNodeParent=function(f,d,e){if(f){while(f.parentNode){if(f===e){return null}if(c.is(f,d)===true){return f}f=f.parentNode}}return null};c.onBlockBoundary=function(g,e,f){if(!g||!e){return false}var d=c.isChildOfTagNames(g,f)||c.is(g,f.join(", "))&&g||null;var h=c.isChildOfTagNames(e,f)||c.is(e,f.join(", "))&&e||null;return(d!==h)};c.isOnBlockBoundary=function(g,f,d){if(!g||!f){return false}var e=c.getBlockParent(g,d)||c.isBlockElement(g,d)&&g||null;var h=c.getBlockParent(f,d)||c.isBlockElement(f,d)&&f||null;return(e!==h)};c.mergeContainers=function(e,d){if(!e||!d){return false}if(e.nodeType===c.TEXT_NODE||c.isStubElement(e)){d.appendChild(e)}else{if(e.nodeType===c.ELEMENT_NODE){while(e.firstChild){d.appendChild(e.firstChild)}c.remove(e)}}return true};c.mergeBlockWithSibling=function(d,g,f){var e=f?jQuery(g).next().get(0):jQuery(g).prev().get(0);if(f){c.mergeContainers(e,g)}else{c.mergeContainers(g,e)}d.collapse(true);return true};c.date=function(q,n,e){if(n===null&&e){n=c.tsIso8601ToTimestamp(e);if(!n){return}}var h=new Date(n);var p=q.split("");var g=p.length;var k="";for(var l=0;l<g;l++){var d="";var m=p[l];switch(m){case"D":case"l":var o=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];d=o[h.getDay()];if(m==="D"){d=d.substring(0,3)}break;case"F":case"m":d=h.getMonth()+1;if(d<10){d="0"+d}break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"];d=months[h.getMonth()];if(m==="M"){d=d.substring(0,3)}break;case"d":d=h.getDate();break;case"S":d=c.getOrdinalSuffix(h.getDate());break;case"Y":d=h.getFullYear();break;case"y":d=h.getFullYear();d=d.toString().substring(2);break;case"H":d=h.getHours();break;case"h":d=h.getHours();if(d===0){d=12}else{if(d>12){d-=12}}break;case"i":d=c.addNumberPadding(h.getMinutes());break;case"a":d="am";if(h.getHours()>=12){d="pm"}break;default:d=m;break}k+=d}return k};c.getOrdinalSuffix=function(e){var f="";var d=(e%100);if(d>=4&&d<=20){f="th"}else{switch(e%10){case 1:f="st";break;case 2:f="nd";break;case 3:f="rd";break;default:f="th";break}}return f};c.addNumberPadding=function(d){if(d<10){d="0"+d}return d};c.tsIso8601ToTimestamp=function(e){var h=/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/;var k=e.match(new RegExp(h));if(k){var f=new Date();f.setDate(k[3]);f.setFullYear(k[1]);f.setMonth(k[2]-1);f.setHours(k[4]);f.setMinutes(k[5]);f.setSeconds(k[6]);var i=(k[9]*60);if(k[8]==="+"){i*=-1}i-=f.getTimezoneOffset();var g=(f.getTime()+(i*60*1000));return g}return null};b.dom=c}).call(this.ice);(function(){var a=this,b;b=function(c){this._selection=null;this.env=c;this._initializeRangeLibrary();this._getSelection()};b.prototype={_getSelection:function(){if(this._selection){this._selection.refresh()}else{if(this.env.frame){this._selection=rangy.getIframeSelection(this.env.frame)}else{this._selection=rangy.getSelection()}}return this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(d){this._selection.refresh();try{return this._selection.getRangeAt(d)}catch(c){this._selection=null;return this._getSelection().getRangeAt(0)}},addRange:function(c){this._selection||(this._selection=this._getSelection());this._selection.setSingleRange(c);this._selection.ranges=[c];return},_initializeRangeLibrary:function(){var d=this;rangy.init();rangy.config.checkSelectionRanges=false;var c=function(g,h,f,e){if(f===0){return}switch(h){case ice.dom.CHARACTER_UNIT:if(f>0){g.moveCharRight(e,f)}else{g.moveCharLeft(e,f*-1)}break;case ice.dom.WORD_UNIT:default:break}};rangy.rangePrototype.moveStart=function(f,e){c(this,f,e,true)};rangy.rangePrototype.moveEnd=function(f,e){c(this,f,e,false)};rangy.rangePrototype.setRange=function(g,e,f){if(g){this.setStart(e,f)}else{this.setEnd(e,f)}};rangy.rangePrototype.moveCharLeft=function(h,g){var f,i;if(h){f=this.startContainer;i=this.startOffset}else{f=this.endContainer;i=this.endOffset}if(f.nodeType===ice.dom.ELEMENT_NODE){if(f.hasChildNodes()){f=f.childNodes[i];f=this.getPreviousTextNode(f);while(f&&f.nodeType==ice.dom.TEXT_NODE&&f.nodeValue===""){f=this.getPreviousTextNode(f)}i=f.data.length-g}else{i=g*-1}}else{i-=g}if(i<0){while(i<0){var e=[];f=this.getPreviousTextNode(f,e);if(!f){return}if(f.nodeType===ice.dom.ELEMENT_NODE){continue}i+=f.data.length}}this.setRange(h,f,i)};rangy.rangePrototype.moveCharRight=function(h,g){var f,k;if(h){f=this.startContainer;k=this.startOffset}else{f=this.endContainer;k=this.endOffset}if(f.nodeType===ice.dom.ELEMENT_NODE){f=f.childNodes[k];if(f.nodeType!==ice.dom.TEXT_NODE){f=this.getNextTextNode(f)}k=g}else{k+=g}var i=(k-f.data.length);if(i>0){var e=[];while(i>0){f=this.getNextContainer(f,e);if(!f){return}if(f.nodeType===ice.dom.ELEMENT_NODE){continue}if(f.data.length>=i){break}else{if(f.data.length>0){i-=f.data.length}}}k=i}this.setRange(h,f,k)};rangy.rangePrototype.getNextContainer=function(f,e){if(!f){return null}while(f.nextSibling){f=f.nextSibling;if(f.nodeType!==ice.dom.TEXT_NODE){var h=this.getFirstSelectableChild(f);if(h!==null){return h}}else{if(this.isSelectable(f)===true){return f}}}while(f&&!f.nextSibling){f=f.parentNode}if(!f){return null}f=f.nextSibling;if(this.isSelectable(f)===true){return f}else{if(e&&ice.dom.isBlockElement(f)===true){e.push(f)}}var g=this.getFirstSelectableChild(f);if(g!==null){return g}return this.getNextContainer(f,e)};rangy.rangePrototype.getPreviousContainer=function(f,e){if(!f){return null}while(f.previousSibling){f=f.previousSibling;if(f.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isStubElement(f)===true){return f}else{var h=this.getLastSelectableChild(f);if(h!==null){return h}}}else{if(this.isSelectable(f)===true){return f}}}while(f&&!f.previousSibling){f=f.parentNode}if(!f){return null}f=f.previousSibling;if(this.isSelectable(f)===true){return f}else{if(e&&ice.dom.isBlockElement(f)===true){e.push(f)}}var g=this.getLastSelectableChild(f);if(g!==null){return g}return this.getPreviousContainer(f,e)};rangy.rangePrototype.getNextTextNode=function(e){if(e.nodeType===ice.dom.ELEMENT_NODE){if(e.childNodes.length!==0){return this.getFirstSelectableChild(e)}}e=this.getNextContainer(e);if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getNextTextNode(e)};rangy.rangePrototype.getPreviousTextNode=function(e,f){e=this.getPreviousContainer(e,f);if(e.nodeType===ice.dom.TEXT_NODE){return e}return this.getPreviousTextNode(e,f)};rangy.rangePrototype.getFirstSelectableChild=function(f){if(f){if(f.nodeType!==ice.dom.TEXT_NODE){var g=f.firstChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.firstChild){var e=this.getFirstSelectableChild(g);if(e!==null){return e}else{g=g.nextSibling}}else{g=g.nextSibling}}}}else{return f}}return null};rangy.rangePrototype.getLastSelectableChild=function(f){if(f){if(f.nodeType!==ice.dom.TEXT_NODE){var g=f.lastChild;while(g){if(this.isSelectable(g)===true){return g}else{if(g.lastChild){var e=this.getLastSelectableChild(g);if(e!==null){return e}else{g=g.previousSibling}}else{g=g.previousSibling}}}}else{return f}}return null};rangy.rangePrototype.isSelectable=function(e){if(e&&e.nodeType===ice.dom.TEXT_NODE&&e.data.length!==0){return true}return false};rangy.rangePrototype.getHTMLContents=function(e){if(!e){e=this.cloneContents()}var f=d.env.document.createElement("div");f.appendChild(e.cloneNode(true));return f.innerHTML};rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}};a.Selection=b}).call(this.ice);(function(){var a=this,b;b=function(i,f,p){this.env=i;this.element=i.element;this.selection=this.env.selection;if(!p){this.removeBookmarks(this.element)}var n=f||this.selection.getRangeAt(0),f=n.cloneRange(),c=f.startContainer,o=f.endContainer,l=f.startOffset,m=f.endOffset,d;f.collapse(false);var h=this.env.document.createElement("span");h.style.display="none";ice.dom.setHtml(h,"&nbsp;");ice.dom.addClass(h,"iceBookmark iceBookmark_end");h.setAttribute("iceBookmark","end");f.insertNode(h);if(!ice.dom.isChildOf(h,this.element)){this.element.appendChild(h)}f.setStart(c,l);f.collapse(true);var g=this.env.document.createElement("span");g.style.display="none";ice.dom.addClass(g,"iceBookmark iceBookmark_start");ice.dom.setHtml(g,"&nbsp;");g.setAttribute("iceBookmark","start");try{f.insertNode(g);if(g.previousSibling===h){d=g;g=h;h=d}}catch(k){ice.dom.insertBefore(h,g)}if(ice.dom.isChildOf(g,this.element)===false){if(this.element.firstChild){ice.dom.insertBefore(this.element.firstChild,g)}else{this.element.appendChild(g)}}if(!h.previousSibling){d=this.env.document.createTextNode("");ice.dom.insertBefore(h,d)}if(!g.nextSibling){d=this.env.document.createTextNode("");ice.dom.insertAfter(g,d)}n.setStart(g.nextSibling,0);n.setEnd(h.previousSibling,(h.previousSibling.length||0));this.start=g;this.end=h};b.prototype={selectBookmark:function(){var d=this.selection.getRangeAt(0);var h=null;var g=null;var c=0;var f=null;if(this.start.nextSibling===this.end||ice.dom.getElementsBetween(this.start,this.end).length===0){if(this.end.nextSibling){h=ice.dom.getFirstChild(this.end.nextSibling)}else{if(this.start.previousSibling){h=ice.dom.getFirstChild(this.start.previousSibling);if(h.nodeType===ice.dom.TEXT_NODE){c=h.length}}else{this.end.parentNode.appendChild(this.env.document.createTextNode(""));h=ice.dom.getFirstChild(this.end.nextSibling)}}}else{if(this.start.nextSibling){h=ice.dom.getFirstChild(this.start.nextSibling)}else{if(!this.start.previousSibling){var i=this.env.document.createTextNode("");ice.dom.insertBefore(this.start,i)}h=ice.dom.getLastChild(this.start.previousSibling);c=h.length}if(this.end.previousSibling){g=ice.dom.getLastChild(this.end.previousSibling)}else{g=ice.dom.getFirstChild(this.end.nextSibling||this.end);f=0}}ice.dom.remove([this.start,this.end]);if(g===null){d.setEnd(h,c);d.collapse(false)}else{d.setStart(h,c);if(f===null){f=(g.length||0)}d.setEnd(g,f)}try{this.selection.addRange(d)}catch(k){}},getBookmark:function(d,c){var e=ice.dom.getClass("iceBookmark_"+c,d)[0];return e},removeBookmarks:function(c){ice.dom.remove(ice.dom.getClass("iceBookmark",c,"span"))}};a.Bookmark=b}).call(this.ice);var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking"},Commands:{TOGGLE_TRACKING:"lite.ToggleTracking",TOGGLE_SHOW:"lite.ToggleShow",ACCEPT_ALL:"lite.AcceptAll",REJECT_ALL:"lite.RejectAll",ACCEPT_ONE:"lite.AcceptOne",REJECT_ONE:"lite.RejectOne",TOGGLE_TOOLTIPS:"lite.ToggleTooltips"}};
/* Copyright (C) 2014 LoopIndex - All Rights Reserved
 * You may use, distribute and modify this code under the
 * terms of the LoopIndex Comments CKEditor plugin license.
 *
 * You should have received a copy of the LoopIndex Comments CKEditor plugin license with
 * this file. If not, please write to: loopindex@gmail.com, or visit http://www.loopindex.com
 * written by (David *)Frenkiel (https://github.com/imdfl) 
 */